<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://www.sysctl.me').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","width":320,"display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="第 1 章 简单MULTIPATH 功能实现实现dm功能如果仅仅是想实现多路径功能  请直接安装 device-mapper-multipath  1yum install  -y device-mapper-multipath 修改 &#x2F;etc&#x2F;multipath.conf 配置文件内容 生效内容为以下 123456789blacklist &amp;#123;devnode &quot;^sda&quot;&amp;#125;de">
<meta property="og:type" content="article">
<meta property="og:title" content="Device Mapper Multipathing">
<meta property="og:url" content="https://www.sysctl.me/2017/09/16/Linux/storage/multipath/index.html">
<meta property="og:site_name" content="Sysctl">
<meta property="og:description" content="第 1 章 简单MULTIPATH 功能实现实现dm功能如果仅仅是想实现多路径功能  请直接安装 device-mapper-multipath  1yum install  -y device-mapper-multipath 修改 &#x2F;etc&#x2F;multipath.conf 配置文件内容 生效内容为以下 123456789blacklist &amp;#123;devnode &quot;^sda&quot;&amp;#125;de">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-image.nos-eastchina1.126.net/m45k774b6m.png?imageslim">
<meta property="og:image" content="https://blog-image.nos-eastchina1.126.net/DacBIGBIg1.png?imageslim">
<meta property="og:image" content="https://blog-image.nos-eastchina1.126.net/GLD42i9FI3.png?imageslim">
<meta property="article:published_time" content="2017-09-16T13:12:59.000Z">
<meta property="article:modified_time" content="2020-01-22T14:36:25.145Z">
<meta property="article:author" content="Goooo">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Storage">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-image.nos-eastchina1.126.net/m45k774b6m.png?imageslim">

<link rel="canonical" href="https://www.sysctl.me/2017/09/16/Linux/storage/multipath/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Device Mapper Multipathing | Sysctl</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Sysctl" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sysctl</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Too young, too simple. Sometimes, naive & stupid</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/xth0331" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.sysctl.me/2017/09/16/Linux/storage/multipath/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/img.png">
      <meta itemprop="name" content="Goooo">
      <meta itemprop="description" content="真正的粉丝">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sysctl">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Device Mapper Multipathing
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-09-16 21:12:59" itemprop="dateCreated datePublished" datetime="2017-09-16T21:12:59+08:00">2017-09-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-01-22 22:36:25" itemprop="dateModified" datetime="2020-01-22T22:36:25+08:00">2020-01-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2017/09/16/Linux/storage/multipath/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/09/16/Linux/storage/multipath/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="第-1-章-简单MULTIPATH-功能实现"><a href="#第-1-章-简单MULTIPATH-功能实现" class="headerlink" title="第 1 章 简单MULTIPATH 功能实现"></a>第 1 章 简单MULTIPATH 功能实现</h1><h2 id="实现dm功能"><a href="#实现dm功能" class="headerlink" title="实现dm功能"></a>实现dm功能</h2><p>如果仅仅是想实现多路径功能  请直接安装 device-mapper-multipath </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install  -y device-mapper-multipath</span><br></pre></td></tr></table></figure>
<p>修改 /etc/multipath.conf 配置文件内容</p>
<p>生效内容为以下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">blacklist &#123;</span><br><span class="line">devnode <span class="string">"^sda"</span></span><br><span class="line">&#125;</span><br><span class="line">defaults &#123;</span><br><span class="line">		user_friendly_names yes</span><br><span class="line">		path_grouping_policy multibus</span><br><span class="line">		failback immediate</span><br><span class="line">		no_path_retry fail</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>sda为你要排除的非多路径设备</em></p>
<p>然后你启动服务就好咯<br><a id="more"></a><br>CentOS6</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service multipathd start</span><br><span class="line">chkconfig multipathd on</span><br></pre></td></tr></table></figure>
<p>CentOS7</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start multipathd</span><br><span class="line">systemctl <span class="built_in">enable</span> multipathd</span><br></pre></td></tr></table></figure>
<p>服务启动了， 看看多路径现在的状态吧</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multipath -ll</span><br></pre></td></tr></table></figure>
<p> 然后查看下 /dev/mapper/ 目录下是否多了mpath开头的设备文件</p>
<p>如果有  <code>fdisk -l</code>看下</p>
<p>可以格式化 或者创建pv咯</p>
<p>因为多路径为san设备， 所以开机挂在需要谨慎，写fstab时 主要要使用  <code>_netdev</code>选项</p>
<p>例如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/mapper/Xsky-Xsky   /xsky       xfs    defaults,_netdev        0 0</span><br></pre></td></tr></table></figure>
<p>下面的内容都是参考官方文档， 整理到这里是为了以后不会配置去百度！！！</p>
<h2 id="DM-MULTIPATH-概述"><a href="#DM-MULTIPATH-概述" class="headerlink" title="DM MULTIPATH 概述"></a>DM MULTIPATH 概述</h2><p>可使用 DM Multipath 提供以下功能：</p>
<ul>
<li><p>冗余</p>
<p>DM Multipath 能够在主动／被动配置下提供故障转移。在主动／被动配置下，只有一半的路径在每次进行 I/O 时会被使用。若一条 I/O 路径的任一元素（电缆、交换器或者控制器）出现故障，DM Multipath 就会将它切换到备用路径。</p>
<p>​</p>
</li>
<li><p>改进的性能</p>
<p>​</p>
<p>可将 DM Multipath 配置为主动／主动模式， 这会将 I/O 以轮循机制（round-robin）的方式分布到所有的路径中。在有些配置中，DM Multipath 能够检测 I/O 路径的负载，并且重新动态平衡负载。</p>
</li>
</ul>
<p>图 1.1 “带一个 RAID 设备的主动／被动多路径配置”演示了在服务器和 RAID 设备之间有两个 I/O 路径的主动／被动配置。这里服务器中有两个 HBA，两个 SAN 交换机以及两个 RAID 控制器。</p>
<p>⁠</p>
<p><img src="https://blog-image.nos-eastchina1.126.net/m45k774b6m.png?imageslim" alt="mark"></p>
<p>​<strong>图 1.1. 带一个 RAID 设备的主动／被动多路径配置</strong></p>
<p>在这个配置中，一个 I/O 路径通过 hba1、SAN1 以及控制器 1。另一个 I/O 路径通过 hba2、SAN2 以及控制器 2。在这个配置中有很多地方可能出现故障：</p>
<ul>
<li>HBA 故障</li>
<li>FC 电缆故障</li>
<li>SAN 交换机故障</li>
<li>阵列控制器端口故障</li>
</ul>
<p>阵列控制器端口故障</p>
<p>图 1.2 “带两个 RAID 设备的主动／被动多路径配置” 演示了更复杂的主动／被动配置，其中服务器中有两个 HBA、两个 SAN 交换机以及两个 RAID 设备（每个带两个 RAID 控制器）。</p>
<p>⁠</p>
<p><img src="https://blog-image.nos-eastchina1.126.net/DacBIGBIg1.png?imageslim" alt="mark"></p>
<p>​<strong>图 1.2. 带两个 RAID 设备的主动／被动多路径配置</strong></p>
<p>在图 1.2 “带两个 RAID 设备的主动／被动多路径配置”演示的示例中，每个 RAID 设备都有两个 I/O 路径（与 图 1.1 “带一个 RAID 设备的主动／被动多路径配置”的示例相同）。如果配置了 DM Multipath，任一 RAID 设备的 I/O 路径的任一点出现故障，都将会导致 DM Multipath 为该设备切换到备用 I/O 路径。</p>
<p>图 1.3 “带一个 RAID 设备的主动/主动多路径配置” 演示在服务器中有两个 HBA、一个 SAN 交换机以及两个 RAID 控制器的主动／主动配置。在服务器和存储设备间有四条 I/O 路径：</p>
<ul>
<li>hba1 到控制器 1</li>
<li>hba1 到控制器 2</li>
<li>hba2 到控制器 1</li>
<li>hba2 到控制器 2</li>
</ul>
<p>在这个配置中，可将 I/O 分布到上述四条路径中。</p>
<p>⁠</p>
<p><img src="https://blog-image.nos-eastchina1.126.net/GLD42i9FI3.png?imageslim" alt="mark"></p>
<p>​<strong>图 1.3. 带一个 RAID 设备的主动/主动多路径配置</strong></p>
<h2 id="存储阵列支持"><a href="#存储阵列支持" class="headerlink" title="存储阵列支持"></a>存储阵列支持</h2><p>默认情况下，DM Multipath 支持大多数常用的支持 DM Multipath 的储存阵列。若要了解默认配置值和支持的设备的相关信息，请运行下列指令中的任何一个。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">multipathd show config</span><br><span class="line">multipath -t</span><br></pre></td></tr></table></figure>
<p>若储存阵列支持 DM Multipath 但是默认情况下未被配置，您需要将它加入 DM Multipath 配置文件 <code>multipath.conf</code>。</p>
<p>有些存储阵列对 I/O 错误和路径切换需要特殊处理。这些都需要独立的硬件处理器 kernel 模块。</p>
<h2 id="DM-MULTIPATH-组件"><a href="#DM-MULTIPATH-组件" class="headerlink" title="DM MULTIPATH 组件"></a>DM MULTIPATH 组件</h2><p><a href="#table1.1">表 1.1 “DM Multipath 组件”</a>对 DM Multipath 组件进行了描述。</p>
<p>⁠</p>
<p><span id="table1.1"><strong>表 1.1. DM Multipath 组件</strong></span></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">组件</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>dm-multipath</code> kernel 模块</td>
<td style="text-align:center">为路径和路径组重新指定 I/O 并支持故障转移。</td>
</tr>
<tr>
<td style="text-align:left"><code>mpathconf</code> 工具程序</td>
<td style="text-align:center">配置并启用 DM Multipath。</td>
</tr>
<tr>
<td style="text-align:left"><code>multipath</code> 指令</td>
<td style="text-align:center">列出并配置多路径设备。通常使用 <code>/etc/rc.sysinit</code> 启动，还可以在添加块设备时通过 <code>udev</code> 程序启动。</td>
</tr>
<tr>
<td style="text-align:left"><code>multipathd</code> 守护进程</td>
<td style="text-align:center">监视路径；若路径故障并返回，它可能会启动路径组切换。允许对多路径设备进行交互式修改。若需对 <code>/etc/multipath.conf</code> 文件进行任何修改，都必须重新启动本守护进程。</td>
</tr>
<tr>
<td style="text-align:left"><code>kpartx</code> 命令</td>
<td style="text-align:center">为设备分区生成设备映射器。对于带 DM Multipath 的基于 DOS 的分区来说，使用此命令很有必要。<code>kpartx</code> 命令包含在它自己的软件包当中，但是 <code>device-mapper-multipath</code> 软件包需要依赖它。</td>
</tr>
</tbody>
</table>
</div>
<h2 id="DM-MULTIPATH-设置概述"><a href="#DM-MULTIPATH-设置概述" class="headerlink" title="DM MULTIPATH 设置概述"></a>DM MULTIPATH 设置概述</h2><p>DM Multipath 包含适用于常用多路径配置的已编译默认设置。为系统配置 DM Multipath 的基本步骤如下：</p>
<ol>
<li>安装 <code>device-mapper-multipath</code> rpm。</li>
<li>使用 <code>mpathconf</code> 命令创建配置文件并启用多路径。若无需编辑该配置文件，可使用此命令启动多路径守护程序。</li>
<li>如需编辑该配置文件，请编辑 <code>multipath.conf</code> 配置文件，修改默认值并保存更新的文件。</li>
<li>启动多路径守护进程。</li>
</ol>
<h1 id="第-2-章-多路径设备"><a href="#第-2-章-多路径设备" class="headerlink" title="第 2 章 多路径设备"></a>第 2 章 多路径设备</h1><p>若没有 DM Multipath，从服务器节点到储存控制器的每一条路径都会被系统视为独立的设备，即使 I/O 路径连接的是相同的服务器节点到相同的储存控制器也是如此。DM Multipath 提供了有逻辑的管理 I/O 路径的方法，即在基础设备顶端生成单一多路径设备。</p>
<h2 id="多路径设备识别符"><a href="#多路径设备识别符" class="headerlink" title="多路径设备识别符"></a>多路径设备识别符</h2><p>每个多路径设备都有一个全球识别符（WWID），它是一个全球唯一的无法更改的号码。默认情况下会将多路径设备的名称设定为它的 WWID。另外，您还可以在多路径配置文件中设置 <code>user_friendly_names</code> 选项，该选项可将别名设为格式为 <code>mpath</code><em>n</em> 的节点唯一名称。</p>
<p>例如：有两个 HBA 的节点通过单一不分区 FC 交换机附加到有两个端口的储存控制器中时，可看到四个设备：<code>/dev/sda</code>、<code>/dev/sdb</code>、<code>dev/sdc</code> 以及 <code>/dev/sdd</code>。DM Multipath 会生成由唯一 WWID 的单一设备，该设备可根据多路径配置将 I/O 重新路由到那四个基础设备。<code>user_friendly_names</code> 配置选项的值被设为 <code>yes</code> 时，多路径设备的名称会被设定为 <code>mpath</code><em>n</em>。</p>
<p>新设备被纳入 DM Multipath 控制时，该设备会显示在 <code>/dev</code> 目录的两个不同位置： <code>/dev/mapper/mpath</code><em>n</em> 和 <code>/dev/dm-</code><em>n</em>。</p>
<ul>
<li><code>/dev/mapper</code> 中的设备是在引导过程中生成的。可使用这些设备访问多路径设备，例如在生成逻辑卷时。</li>
<li>任何 <code>/dev/dm-</code><em>n</em> 格式的设备都只适用于内部使用，管理员请勿直接使用。</li>
</ul>
<h2 id="在集群中保持多路径设备名称一致"><a href="#在集群中保持多路径设备名称一致" class="headerlink" title="在集群中保持多路径设备名称一致"></a>在集群中保持多路径设备名称一致</h2><p>当将 <code>user_friendly_names</code> 配置选项设为 <code>yes</code> 时，该多路径设备的名称对于节点来说是唯一的，但不保证对使用多路径设备的所有节点都一致。同样，如果您为 <code>multipath.conf</code> 配置文件的 <code>multipaths</code> 部分中的设备设定 <code>alias</code> 选项，该名称不会自动在集群的所有节点中保持一致。如果您使用 LVM 在多路径设备中创建逻辑设备，这不应是问题。但如果您需要将您的多路径设备名称在集群中的每个节点上都保持一致，请不要将 <code>user_friendly_names</code> 选项设定为 <code>yes</code>，且不要为那些设备配置别名。默认情况下，如果您不将 <code>user_friendly_names</code> 设定为 <code>yes</code>，或者为某个设备配置别名，则设备名称将是该设备的 WWID，它是不会变的。</p>
<p>如果您要系统定义的用户友好名称在集群的所有节点中都一致，您可按照以下步骤操作：</p>
<ol>
<li><p>在一台机器中设定所有多路径设备。</p>
</li>
<li><p>运行以下命令禁用其它机器上所有的多路径设备：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service multipathd stop</span><br><span class="line">multipath -F</span><br></pre></td></tr></table></figure>
</li>
<li><p>将第一台机器中的 <code>/etc/multipath/bindings</code> 文件复制到集群中的其它所有机器中。</p>
</li>
<li><p>使用以下命令在集群的其他机器中重新 <code>multipathd</code> 守护进程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service multipathd start</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如果您添加新设备，您将需要重复这个过程。</p>
<p>同样，如果您为某个设备配置别名以便在集群的节点中使其保持一致，您应确定 <code>/etc/multipath.conf</code> 文件对于集群中的每个节点都是一样的，步骤如下：</p>
<ol>
<li><p>为一台机器上 <code>multipath.conf</code> 文件中的多路径设备配置别名。</p>
</li>
<li><p>运行以下命令禁用其它机器上所有的多路径设备：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service multipathd stop</span><br><span class="line">multipath -F</span><br></pre></td></tr></table></figure>
</li>
<li><p>将第一台机器中的 <code>/etc/multipath.conf</code> 文件复制到集群中的其它所有机器中。</p>
</li>
<li><p>使用以下命令在集群的其他机器中重新 <code>multipathd</code> 守护进程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service multipathd start</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>当您添加新设备时，您将需要重复这个过程。</p>
<h2 id="多路径设备属性"><a href="#多路径设备属性" class="headerlink" title="多路径设备属性"></a>多路径设备属性</h2><p>除 <code>user_friendly_names</code> 和 <code>alias</code> 选项外，multipath 设备有大量属性。您可以为具体 multipath 设备修改这些属性，方法是在 multipath 配置文件的 <code>multipaths</code> 部分为那个设备创建一个条目。</p>
<h2 id="逻辑卷中的多路径设备"><a href="#逻辑卷中的多路径设备" class="headerlink" title="逻辑卷中的多路径设备"></a>逻辑卷中的多路径设备</h2><p>生成多路径设备后，多路径设备的名称可以与您生成一个 LVM 物理卷时使用的物理设备名称相同。例如：如果多路径名称为 <code>/dev/mapper/mpatha</code>，以下命令可将 <code>/dev/mapper/mpatha</code> 标记为一个物理卷。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pvcreate /dev/mapper/mpatha</span><br></pre></td></tr></table></figure>
<p>您可以如在使用其它 LVM 物理设备一样在创建 LVM 卷组时使用得到的 LVM 物理卷。</p>
<p><strong><em>注意</em></strong></p>
<p><em>如果您要在配置了分区的整个设备中创建 LVM 物理卷，<code>pvcreate</code> 命令将会失败。请注意：如果您不具体指定每个块设备，Anaconda 和 Kickstart 安装程序会生成空分区表。您可以使用 <code>kpartx -d</code> 和 <code>fdisk</code> 命令删除现有分区。如果您的系统有大于 2 TB 的块设备，您可使用 <code>parted</code> 命令删除分区。</em></p>
<p>当您创建使用主动／被动多路径阵列的 LVM 逻辑卷作为基础物理设备时，您应该在 <code>/etc/lvm/lvm.conf</code> 文件中添加过滤器，以排除构成多路径设备的磁盘。这是因为如果不过滤，阵列在接收到 I/O 时自动从主动路径切换到被动路径，只要 LVM 扫描到被动路径，多路径将会进行故障转移和自动恢复。对于需要使用命令激活被动路径的主动／被动阵列，LVM 会给出警告信息。</p>
<p>要过滤 LVM 配置文件（<code>lvm.conf</code>）中的所有 SCSI 设备，请在该文件的 <code>devices</code> 部分添加以下过滤器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter = [ <span class="string">"r/block/"</span>, <span class="string">"r/disk/"</span>, <span class="string">"r/sd.*/"</span>, <span class="string">"a/.*/"</span> ]</span><br></pre></td></tr></table></figure>
<h1 id="第-3-章-设置-DM-MULTIPATH"><a href="#第-3-章-设置-DM-MULTIPATH" class="headerlink" title="第 3 章 设置 DM MULTIPATH"></a>第 3 章 设置 DM MULTIPATH</h1><p>配置 DM Multipath 的分步示例，其中包括以下步骤：</p>
<ul>
<li>基本 DM Multipath 设置</li>
<li>忽略本地磁盘</li>
<li>在配置文件中添加更多设备</li>
<li>在 <code>initramfs</code> 文件系统中启动 Multipath</li>
</ul>
<h2 id="设置-DM-MULTIPATH"><a href="#设置-DM-MULTIPATH" class="headerlink" title="设置 DM MULTIPATH"></a>设置 DM MULTIPATH</h2><p>安装 DM-Multipath 前，请确定系统已升级，其中包括 <code>device-mapper-multipath</code> 软件包升级。</p>
<p>可使用 <code>mpathconf</code> 程序设置多路径，它可创建多路径配置文件 <code>/etc/multipath.conf</code>。</p>
<ul>
<li>如果 <code>/etc/multipath.conf</code> 文件已存在，<code>mpathconf</code> 程序将会编辑该文件。</li>
<li>如果 <code>/etc/multipath.conf</code> 文件不存在，<code>mpathconf</code> 程序将使用 <code>/usr/share/doc/device-mapper-multipath-0.4.9/multipath.conf</code> 文件作为起始文件。</li>
<li>如果 <code>/usr/share/doc/device-mapper-multipath-0.4.9/multipath.conf</code> 文件不存在，则 <code>mpathconf</code> 程序将从头开始创建 <code>/etc/multipath.conf</code> 文件。</li>
</ul>
<p>如果不需要编辑 <code>/etc/multipath.conf</code> 文件，则可以运行以下命令为 DM-Multipath 设定基本故障切换配置。这个命令可启用多路径配置文件并启动 <code>multipathd</code> 守护进程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpathconf --<span class="built_in">enable</span> --with_multipathd y</span><br></pre></td></tr></table></figure>
<p>如果需要在启动 <code>multipathd</code> 守护进程前编辑 <code>/etc/multipath.conf</code> 文件，请执行以下步骤为 DM-Multipath 设置基本故障切换配置。</p>
<ol>
<li><p>运行带 <code>--enable</code> 选项的 <code>mpathconf</code> 命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpathconf --<span class="built_in">enable</span></span><br></pre></td></tr></table></figure>
<p>有关可能需要的 <code>mpathconf</code> 命令的其它选项，请参考 <code>mpathconf</code> 手册页，或者运行指定 <code>--help</code> 选项的 <code>mpathconf</code> 命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mpathconf --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">usage: /sbin/mpathconf &lt;<span class="built_in">command</span>&gt;</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">Enable: --<span class="built_in">enable</span> </span><br><span class="line">Disable: --<span class="built_in">disable</span></span><br><span class="line">Set user_friendly_names (Default y): --user_friendly_names &lt;y|n&gt;</span><br><span class="line">Set find_multipaths (Default y): --find_multipaths &lt;y|n&gt; </span><br><span class="line">Load the dm-multipath modules on <span class="built_in">enable</span> (Default y): --with_module  &lt;y|n&gt;</span><br><span class="line">start/stop/reload multipathd (Default n): --with_multipathd  &lt;y|n&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>必要时请编辑 <code>/etc/multipath.conf</code> 文件。会将 DM Multipath 的默认设置编译到系统中，且无需在 <code>/etc/multipath.conf</code> 文件中明确设定。</p>
<p><code>path_grouping_policy</code> 的默认值是设为 <code>failover</code>，因此在这个示例中您不需要编辑 <code>/etc/multipath.conf</code> 文件。</p>
<p>在您系统配置文件的初始默认部分配置您的系统以便多路径设备的名称格式为 <code>mpath</code><em>n</em>。如果没有这个设置，多路径设备的名称将会是该设备 WWID 别名。</p>
</li>
<li><p>需要时保存配置文件并退出编辑器。</p>
</li>
<li><p>执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service multipathd start</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>因为在配置文件中将 <code>user_friendly_name</code> 值设为 <code>yes</code>，那么生成的多路径设备将为 <code>/dev/mapper/mpath</code><em>n</em>。</p>
<p>如果不想使用用户友好名称，可以运行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpathconf --<span class="built_in">enable</span> --user_friendly_names n</span><br></pre></td></tr></table></figure>
<p><strong><em>注意</em></strong></p>
<p><em>如果在启动 multipath 守护进程后发现需要编辑 multipath 配置文件，则必须执行 <code>service multipathd reload</code> 命令方可使更改生效。</em></p>
<h2 id="在生成多路径设备时忽略逻辑磁盘"><a href="#在生成多路径设备时忽略逻辑磁盘" class="headerlink" title="在生成多路径设备时忽略逻辑磁盘"></a>在生成多路径设备时忽略逻辑磁盘</h2><p>有些机器在其内部磁盘中有本地 SCSI 卡。不建议在这些设备中使用 DM Multipath。如果将 <code>find_multipaths</code> 配置参数设定为 <code>yes</code>，则不一定要将这些设备列入黑名单。</p>
<p>如果没有将 <code>find_multipaths</code> 配置参数设定为 <code>yes</code>，则可以使用以下步骤修改多路径配置文件，以便在配置多路径时忽略本地磁盘。</p>
<ol>
<li><p>确定哪些磁盘是内部磁盘并将其列入黑名单。</p>
<p>在这个示例中，<code>/dev/sda</code> 是内部磁盘。注：因为在默认多路径配置文件中已经对其进行了配置，所以执行 <code>multipath -v2</code> 会在多路径映射中显示本地磁盘 <code>/dev/sda</code>。</p>
<p>​</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># multipath -v2</span></span><br><span class="line">create: SIBM-ESXSST336732LC____F3ET0EP0Q000072428BX1 undef WINSYS,SF2372</span><br><span class="line">size=33 GB features=<span class="string">"0"</span> hwhandler=<span class="string">"0"</span> wp=undef</span><br><span class="line">`-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=undef</span><br><span class="line">  |- 0:0:0:0 sda 8:0  [--------- </span><br><span class="line"></span><br><span class="line">device-mapper ioctl cmd 9 failed: Invalid argument</span><br><span class="line">device-mapper ioctl cmd 14 failed: No such device or address</span><br><span class="line">create: 3600a0b80001327d80000006d43621677 undef WINSYS,SF2372</span><br><span class="line">size=12G features=<span class="string">'0'</span> hwhandler=<span class="string">'0'</span> wp=undef</span><br><span class="line">`-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=undef</span><br><span class="line">  |- 2:0:0:0 sdb 8:16  undef ready  running</span><br><span class="line">  `- 3:0:0:0 sdf 8:80 undef ready  running</span><br><span class="line"></span><br><span class="line">create: 3600a0b80001327510000009a436215ec undef WINSYS,SF2372</span><br><span class="line">size=12G features=<span class="string">'0'</span> hwhandler=<span class="string">'0'</span> wp=undef</span><br><span class="line">`-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=undef</span><br><span class="line">  |- 2:0:0:1 sdc 8:32 undef ready  running</span><br><span class="line">  `- 3:0:0:1 sdg 8:96 undef ready  running</span><br><span class="line"></span><br><span class="line">create: 3600a0b80001327d800000070436216b3 undef WINSYS,SF2372</span><br><span class="line">size=12G features=<span class="string">'0'</span> hwhandler=<span class="string">'0'</span> wp=undef</span><br><span class="line">`-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=undef</span><br><span class="line">  |- 2:0:0:2 sdd 8:48 undef ready  running</span><br><span class="line">  `- 3:0:0:2 sdg 8:112 undef ready  running</span><br><span class="line"></span><br><span class="line">create: 3600a0b80001327510000009b4362163e undef WINSYS,SF2372</span><br><span class="line">size=12G features=<span class="string">'0'</span> hwhandler=<span class="string">'0'</span> wp=undef</span><br><span class="line">`-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=undef</span><br><span class="line">  |- 2:0:0:3 sdd 8:64 undef ready  running</span><br><span class="line">  `- 3:0:0:3 sdg 8:128 undef ready  running</span><br></pre></td></tr></table></figure>
<ol>
<li><p>为防止设备映射器将 <code>/dev/sda</code> 与其多路径对应，请编辑 <code>/etc/multipath.conf</code> 文件的 blacklist 部分，使其包括该设备。虽然可以使用 <code>devnode</code> 类型将 <code>sda</code> 设备列入黑名单，但并不安全，因为重启时无法保证 <code>/dev/sda</code> 使用同一个名称。要将单独的设备列入黑名单，可以使用那个设备的 WWID 将其列入黑名单。</p>
<p>请注意：在 <code>multipath -v2</code> 命令的输出中，<code>/dev/sda</code> 设备的 WWID 是 SIBM-ESXSST336732LC____F3ET0EP0Q000072428BX1。要将这个设备列入黑名单，请在 <code>/etc/multipath.conf</code> 文件中添加以下内容。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">blacklist &#123;</span><br><span class="line">      wwid SIBM-ESXSST336732LC____F3ET0EP0Q000072428BX1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新 <code>/etc/multipath.conf</code> 文件后，必须手动让 <code>multipathd</code> 守护进程重新载入该文件。以下命令可重新载入更新的 <code>/etc/multipath.conf</code> 文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service multipathd reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行以下命令删除多路径设备：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multipath -f SIBM-ESXSST336732LC____F3ET0EP0Q000072428BX1</span><br></pre></td></tr></table></figure>
</li>
<li><p>要查看是否删除了该设备，可以输入 <code>multipath -ll</code> 命令显示当前的多路径配置。</p>
<p>要确定被列入黑名单的设备没有被重新添加回来，可输入 <code>multipath</code> 命令，如下所示。如果没有指定 <code>-v</code> 选项，则 <code>multipath</code> 命令默认详细等级为 <code>v2</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">multipath</span><br><span class="line"></span><br><span class="line">create: 3600a0b80001327d80000006d43621677 undef WINSYS,SF2372</span><br><span class="line">size=12G features=<span class="string">'0'</span> hwhandler=<span class="string">'0'</span> wp=undef</span><br><span class="line">`-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=undef</span><br><span class="line">  |- 2:0:0:0 sdb 8:16  undef ready  running</span><br><span class="line">  `- 3:0:0:0 sdf 8:80 undef ready  running</span><br><span class="line"></span><br><span class="line">create: 3600a0b80001327510000009a436215ec undef WINSYS,SF2372</span><br><span class="line">size=12G features=<span class="string">'0'</span> hwhandler=<span class="string">'0'</span> wp=undef</span><br><span class="line">`-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=undef</span><br><span class="line">  |- 2:0:0:1 sdc 8:32 undef ready  running</span><br><span class="line">  `- 3:0:0:1 sdg 8:96 undef ready  running</span><br><span class="line"></span><br><span class="line">create: 3600a0b80001327d800000070436216b3 undef WINSYS,SF2372</span><br><span class="line">size=12G features=<span class="string">'0'</span> hwhandler=<span class="string">'0'</span> wp=undef</span><br><span class="line">`-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=undef</span><br><span class="line">  |- 2:0:0:2 sdd 8:48 undef ready  running</span><br><span class="line">  `- 3:0:0:2 sdg 8:112 undef ready  running</span><br><span class="line"></span><br><span class="line">create: 3600a0b80001327510000009b4362163e undef WINSYS,SF2372</span><br><span class="line">size=12G features=<span class="string">'0'</span> hwhandler=<span class="string">'0'</span> wp=undef</span><br><span class="line">`-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=undef</span><br><span class="line">  |- 2:0:0:3 sdd 8:64 undef ready  running</span><br><span class="line">  `- 3:0:0:3 sdg 8:128 undef ready  running</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="配置存储设备"><a href="#配置存储设备" class="headerlink" title="配置存储设备"></a>配置存储设备</h2><p>默认情况下，DM Multipath 支持大多数常用的支持 DM Multipath 的储存阵列。若要了解默认配置值和支持的设备的相关信息，请运行下列指令中的任意一个。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">multipathd show config</span><br><span class="line">multipath -t</span><br></pre></td></tr></table></figure>
<p>如果需要添加一个在默认情况下不支持的存储设备作为已知多路径设备，请编辑 <code>/etc/multipath.conf</code> 文件，并插入正确的设备信息。</p>
<p>例如：要添加有关 HP Open-V 系列的信息（其条目示例如下）。在这个示例中将设备设定在所有路径均失败后排队 1 分钟（或 12 次尝试，每 5 秒后重试一次）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">devices &#123;</span><br><span class="line">        device &#123;</span><br><span class="line">                vendor <span class="string">"HP"</span></span><br><span class="line">                product <span class="string">"OPEN-V"</span></span><br><span class="line">                no_path_retry 12</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="在-INITRAMFS-文件系统中设置启动-MULTIPATH"><a href="#在-INITRAMFS-文件系统中设置启动-MULTIPATH" class="headerlink" title="在 INITRAMFS 文件系统中设置启动 MULTIPATH"></a>在 INITRAMFS 文件系统中设置启动 MULTIPATH</h2><p>可以在 <code>initramfs</code> 文件系统中设定启动 multipath。配置 multipath 后，可使用该 multipath 配置文件重建 <code>initramfs</code> 文件系统，方法是执行附带以下选项的 <code>dracut</code> 命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dracut --force --add multipath --include /etc/multipath</span><br></pre></td></tr></table></figure>
<p>如果在 <code>initramfs</code> 文件系统中运行 multipath，并更改 multipath 配置文件，则必须重建 <code>initramfs</code>文件系统方可使更改生效。</p>
<h1 id="第-4-章-DM-MULTIPATH-配置文件"><a href="#第-4-章-DM-MULTIPATH-配置文件" class="headerlink" title="第 4 章 DM MULTIPATH 配置文件"></a>第 4 章 DM MULTIPATH 配置文件</h1><p>DM Multipath 默认为大多数常用多路径提供配置值。此外，DM Multipath 还包括对那些本身支持 DM Multipath 的常见储存阵列的支持。如需了解有关默认配置值以及支持的设备的相关信息，请运行下列命令之一。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">multipathd show config</span><br><span class="line">multipath -t</span><br></pre></td></tr></table></figure>
<p>可以编辑 <code>/etc/multipath.conf</code> 配置文件覆盖 DM Multipath 的默认配置值。必要时可在配置文件中添加默认不支持的储存阵列。</p>
<p><strong>注意</strong></p>
<p>可以在 <code>initramfs</code> 文件系统中运行 set up multipathing。如果在 <code>initramfs</code> 文件系统中运行 multipath，并可以更改 multipath 配置文件，则必须重建 <code>initramfs</code> 文件系统以便使更改生效。</p>
<p>本章提供了解析和修改 <code>multipath.conf</code> 文件的详情。它包含以下小节：</p>
<ul>
<li>配置文件概述</li>
<li>配置文件黑名单</li>
<li>配置文件默认</li>
<li>配置文件多路径</li>
<li>配置文件设备</li>
</ul>
<p>在 multipath 配置文件中，只需指定您的配置需要的部分，或者是您想要修改的默认值即可。如果文件中有和您的环境不相关的部分，或者是不需要覆盖的默认值，可以将它们注释出来，因为它们位于初始文件中。</p>
<p>配置文件使用正则表达式描述语法。</p>
<p>关于配置文件的详细信息，请参阅 <code>multipath.conf</code>(5) 手册页。</p>
<h2 id="配置文件概述"><a href="#配置文件概述" class="headerlink" title="配置文件概述"></a>配置文件概述</h2><p>多路径配置文件可分为以下几个部分：</p>
<ul>
<li><p>blacklist</p>
<p>不被视为多路径的具体设备列表。</p>
</li>
<li><p>blacklist_exceptions</p>
<p>根据 blacklist 部分中的参数列出不在黑名单中的多路径设备。</p>
</li>
<li><p>defaults</p>
<p>DM Multipath 的常规默认设置。</p>
</li>
<li><p>multipaths</p>
<p>各个独立多路径设备的特性设置。这些数值覆盖了在配置文件的 <code>defaults</code> 和 <code>devices</code> 部分中指定的数值。</p>
</li>
<li><p>devices</p>
<p>各个存储控制器的设置。这些数值覆盖了在配置文件的 <code>defaults</code> 部分指定的数值。如果要使用不是默认支持的存储阵列，则可能需要为您的阵列创建 <code>devices</code> 子部分。</p>
</li>
</ul>
<p>系统决定多路径设备的属性时，会先检查多路径设置，然后检查设备设置，最后才检查多路径系统默认设置。</p>
<h2 id="配置文件黑名单"><a href="#配置文件黑名单" class="headerlink" title="配置文件黑名单"></a>配置文件黑名单</h2><p>多路径配置文件的 <code>blacklist</code> 部分指定在系统配置多路径设备时不能使用的设备。黑名单中的设备将无法分组到多路径设备中。</p>
<p>在旧版 Red Hat Enterprise Linux 中，multipath 总是尝试为每个没有明确列入黑名单的路径创建多路径设备。但在 Red Hat Enterprise Linux 6 中，如果 <code>find_multipaths</code> 配置参数被设定为 <code>yes</code> ， multipath 将只在满足以下三个条件之一时创建设备：</p>
<ul>
<li><p>至少有两个使用同一 WWID 的路径没有被 列入黑名单。</p>
</li>
<li><p>用户可使用 <code>multipath</code> 命令手动强制创建该设备。</p>
</li>
<li><p>有与之前创建的多路径设备相同 WWID 的路径（即使那个多路径设备目前不存在）。无论何时，创建多路径设备后，多路径会记住该设备的 WWID，以便在它看到有使用那个 WWID 的路径时即自动再次创建该设备。这可允许您让多路径自动选择正确的路径以便创建多路径设备而无需编辑多路径黑名单。</p>
<p>如果您之前创建了一个 multipath 设备而没有使用 <code>find_multipaths</code> 参数，然后您随后将该参数设定为 <code>yes</code>，您需要删除所有设备的 WWID，您不想从 <code>/etc/multipath/wwids</code> 文件中将其创建为 multipath 设备。以下显示示例 <code>/etc/multipath/wwids</code> 文件。WWID 由斜线（/）括起来：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Multipath wwids, Version : 1.0</span></span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> This file is automatically maintained by multipath and multipathd.</span></span><br><span class="line"><span class="comment"># You should not need to edit this file in normal circumstances.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Valid WWIDs:</span></span><br><span class="line">/3600d0230000000000e13955cc3757802/</span><br><span class="line">/3600d0230000000000e13955cc3757801/</span><br><span class="line">/3600d0230000000000e13955cc3757800/</span><br><span class="line">/3600d02300069c9ce09d41c31f29d4c00/</span><br><span class="line">/SWINSYS  SF2372         0E13955CC3757802/</span><br><span class="line">/3600d0230000000000e13955cc3757803/</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>如将 <code>find_multipaths</code> 参数设定为 <code>yes</code>，则您只需要将那些您不想使其具有多路径功能的多路径设备列入黑名单，通常不需要将设备列入黑名单。</p>
<p>如果您需要将设备列入黑名单，您可以根据以下条件进行选择：</p>
<ul>
<li>根据 WWID，如<a href="#4.2.1">第 4.2.1 节 “根据 WWID 将设备列入黑名单”</a>所述</li>
<li>根据设备名称，如 <a href="#4.2.2">第 4.2.2 节 “根据设备名称将设备列入黑名单”</a> 所述</li>
<li>根据设备类型，如 <a href="#4.2.3">第 4.2.3 节 “根据设备类型将其加入黑名单”</a>所述</li>
</ul>
<p>默认情况下，各种设备类型都是列在黑名单中的，即使您将配置文件的初始黑名单部分注释出来也是如此。<a href="#4.2.2">第 4.2.2 节 “根据设备名称将设备列入黑名单”</a>。</p>
<p><span id="4.2.1"></span></p>
<h3 id="根据-WWID-将设备列入黑名单"><a href="#根据-WWID-将设备列入黑名单" class="headerlink" title="根据 WWID 将设备列入黑名单"></a>根据 WWID 将设备列入黑名单</h3><p>您可根据全球识别符将单独的设备列入黑名单，即在配置文件的 <code>blacklist</code> 部分加入 <code>wwid</code> 条目。</p>
<p>以下示例显示了在配置文件中可将 WWID 为 26353900f02796769 的设备列入黑名单的行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">blacklist &#123;</span><br><span class="line">       wwid 26353900f02796769</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><span id="4.2.2"></span></p>
<h3 id="根据设备名称将设备列入黑名单"><a href="#根据设备名称将设备列入黑名单" class="headerlink" title="根据设备名称将设备列入黑名单"></a>根据设备名称将设备列入黑名单</h3><p>您可以根据设备名称将设备类型列入黑名单，以便在配置文件 <code>blacklist</code> 部分的 <code>devnode</code> 条目中指定不要将它们分组到多路径设备中。</p>
<p>以下实例显示该配置文件中的可以将所有 SCSI 设备放入黑名单的行，因为它将所有 sd* 设备放入黑名单。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">blacklist &#123;</span><br><span class="line">       devnode <span class="string">"^sd[a-z]"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>您可以使用配置文件 <code>blacklist</code> 部分的 <code>devnode</code> 条目指定要列入黑名单的每个设备，而不是指定具体类型的所有设备，我们不推荐使用后一种情况。除非根据 <code>udev</code> 规则的静态映射，我们无法保证在重启后每个设备的名称是一样的。例如：重启后，某个设备的名称可能从 <code>/dev/sda</code> 变为 <code>/dev/sdb</code>。</p>
<p>默认情况下，以下 <code>devnode</code> 条目将会被列入默认黑名单中；因为这些条目而被列入黑名单的设备通常不支持 DM Multipath。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">blacklist &#123;</span><br><span class="line">       devnode <span class="string">"^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*"</span></span><br><span class="line">       devnode <span class="string">"^(td|ha)d[a-z]"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><span id="4.2.3"></span></p>
<h3 id="根据设备类型将其加入黑名单"><a href="#根据设备类型将其加入黑名单" class="headerlink" title="根据设备类型将其加入黑名单"></a>根据设备类型将其加入黑名单</h3><p>您可以在配置文件的 <code>blacklist</code> 部分与 <code>device</code> 一同指定具0体设备类型。以下实例将所有 IBM DS4200 和 HP 设备放入黑名单。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">blacklist &#123;</span><br><span class="line">       device &#123;</span><br><span class="line">               vendor  <span class="string">"IBM"</span></span><br><span class="line">               product <span class="string">"3S42"</span>       <span class="comment">#DS4200 Product 10</span></span><br><span class="line">       &#125;</span><br><span class="line">       device &#123;</span><br><span class="line">               vendor  <span class="string">"HP"</span></span><br><span class="line">               product <span class="string">"*"</span></span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><span id="根据设备类型将其加入黑名单"></span></p>
<h3 id="黑名单之外的设备"><a href="#黑名单之外的设备" class="headerlink" title="黑名单之外的设备"></a>黑名单之外的设备</h3><p>您可使用配置文件的 <code>blacklist_exceptions</code> 部分为被默认加入黑名单的设备启用多路径。</p>
<p>例如：如果您有大量设备，但只有一个需要多路径（WWID 为 3600d0230000000000e13955cc3757803），您不需要将您想要使用多路径的设备之外的每个设备单独加入黑名单，您只需要将所有设备都加入黑名单，然后在 <code>/etc/multipath.conf</code> 文件中添加以下行以便只允许您想要使用多路径的设备：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">blacklist &#123;</span><br><span class="line">        wwid <span class="string">"*"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">blacklist_exceptions &#123;</span><br><span class="line">        wwid <span class="string">"3600d0230000000000e13955cc3757803"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当在配置文件的 <code>blacklist_exceptions</code> 指定设备时，您必须以指定黑名单的相同方法来指定例外情况。例如：在 <code>devnode</code> 黑名单条目中指定的设备无法使用 WWID 将其指定为例外情况，即使列入黑名单的设备和该 WWID 关联也不行。同样，<code>devnode</code> 例外也只适用于 <code>devnode</code> 条目，而 <code>device</code> 例外只适用于 device 条目。</p>
<h2 id="配置文件默认设置"><a href="#配置文件默认设置" class="headerlink" title="配置文件默认设置"></a>配置文件默认设置</h2><p><code>/etc/multipath.conf</code> 配置文件包括 <code>defaults</code> 部分，在该部分中将 <code>user_friendly_names</code> 参数设为 <code>yes</code>，如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">defaults &#123;</span><br><span class="line">        user_friendly_names yes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这可覆盖 <code>user_friendly_names</code> 参数的默认值。</p>
<p>该配置文件包括配置默认模板。这部分要被注释出来，如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#defaults &#123;</span></span><br><span class="line"><span class="comment">#       polling_interval        10</span></span><br><span class="line"><span class="comment">#       path_selector           "round-robin 0"</span></span><br><span class="line"><span class="comment">#       path_grouping_policy    multibus</span></span><br><span class="line"><span class="comment">#       uid_attribute           ID_SERIAL</span></span><br><span class="line"><span class="comment">#       prio                    alua</span></span><br><span class="line"><span class="comment">#       path_checker            readsector0</span></span><br><span class="line"><span class="comment">#       rr_min_io               100</span></span><br><span class="line"><span class="comment">#       max_fds                 8192</span></span><br><span class="line"><span class="comment">#       rr_weight               priorities</span></span><br><span class="line"><span class="comment">#       failback                immediate</span></span><br><span class="line"><span class="comment">#       no_path_retry           fail</span></span><br><span class="line"><span class="comment">#       user_friendly_names     yes</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure>
<p>要覆盖任意配置参数的默认值，您可将这个模板中相关的行复制到 <code>defaults</code> 部分并取消其注释。例如：要覆盖 <code>path_grouping_policy</code> 参数以便用 <code>multibus</code> 覆盖默认的 <code>failover</code>，请将模板中正确的行复制到配置文件的 <code>defaults</code> 部分并取消对它的注释，如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">defaults &#123;</span><br><span class="line">        user_friendly_names     yes</span><br><span class="line">        path_grouping_policy    multibus</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>表 4.1 “多路径配置默认设置”描述了 <code>multipath.conf</code> 配置文件的 <code>defaults</code> 部分中设置的属性。DM Multipath 会使用这些值，除非该属性被 <code>multipath.conf</code> 文件的 <code>devices</code> 和 <code>multipaths</code> 部分所指定的属性覆盖。</p>
<p>⁠</p>
<p><strong>表 4.1. 多路径配置默认设置</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>polling_interval</code></td>
<td>以秒为单位指定两次路径检查之间的间隔。对正常工作的路径，两次检查间的间隔会逐渐增加到 <code>polling_interval</code> 的四倍。默认值为 5。</td>
</tr>
<tr>
<td><code>multipath_dir</code></td>
<td>保存动态共享对象的目录。默认值依系统而定，通常为 <code>/lib/multipath</code>。</td>
</tr>
<tr>
<td><code>find_multipaths</code></td>
<td>定义设定多路径设备的模式。如果将这个参数设定为 <code>yes</code>，那么多路径将不会尝试为每个不在黑名单中的路径创建设备。反之，多路径将只在满足以下三给条件之一时创建设备：- 至少有两个路径没有使用同一 WWID 列入黑名单。- 用户通过使用 <code>multipath</code> 命令指定设备强制创建该设备。- 路径拥有与之前创建的多路径设备相同的 WWID。无论何时使用 <code>find_multipaths</code> 组件创建多路径设备后，多路径都会记住该设备的 WWID 以便在再次看到使用那个 WWID 的路径时自动创建设备。这可让您自动选择正确的所路径创建多路径设备而无需编辑多路径黑名单。如果之前您在没有设定 <code>find_multipaths</code> 参数的情况下创建了多路径设备，默认值为 <code>no</code>。默认 <code>multipath.conf</code> 文件由 <code>mpathconf</code> 命令生成，但从 Red Hat Enterprise Linux 7 开始才启用 <code>find_multipaths</code>。</td>
</tr>
<tr>
<td><code>reassign_maps</code></td>
<td>启用 device-mapper 映射的创新分配。使用这个选项后，<code>multipathd</code> 守护进程将重新映射现有 device-mapper 映射，使其永远指向多路径设备，而不是基础块设备。可能的值包括 <code>yes</code> 和 <code>no</code>。默认值为 <code>yes</code>。</td>
</tr>
<tr>
<td><code>verbosity</code></td>
<td>默认详情。数值越高则详细程度越高。有效等级在 0 - 6 之间。默认值为 <code>2</code>。</td>
</tr>
<tr>
<td><code>path_selector</code></td>
<td>指定用来决定下一个 I/O 操作所使用路径的默认算法。可能的值包括：<code>round-robin 0</code>：在路径组中循环每个路径，向每个路径发送同样数量的 I/O。<code>queue-length 0</code>：将下一组 I/O 发送到具有最少未处理 I/O 请求的路径。<code>service-time 0</code>：将下一组 I/O 发送到具有最短预计服务时间的路径，这是由未处理 I/O 的总量除以每个路径的相对流量决定的。默认值为 <code>round-robin 0</code>。</td>
</tr>
<tr>
<td><code>path_grouping_policy</code></td>
<td>指定用于未指定路径的默认路径分组策略，可能的值包括：<code>failover</code>：每个优先组群有一个路径。<code>multibus</code>：所有有效路径在一个优先组群中。<code>group_by_serial</code>：每个检测到的系列号有一个优先组群。<code>group_by_prio</code>：每个优先组群有一个路径优先值。优先权根据指定为 global、per-controller 或者 per-multipath 选项的调用程序决定。<code>group_by_node_name</code>：每个目标节点名有一个优先组。目标节点名保存在 <code>/sys/class/fc_transport/target*/node_name</code> 文件中。默认值为 <code>failover</code>。</td>
</tr>
<tr>
<td><code>prio</code></td>
<td>指定要获得路径优先值所需调用的默认程序及参数。例如：SPC-3 中的 ALUA 字节提供了一个可改变的 <code>prio</code> 值。可能的值包括：<code>const</code>：为所有路径设定优先权 1。<code>emc</code>：为 EMC 阵列生成路径优先权。<code>alua</code>：根据 SCSI-3 ALUA 设置生成路径有限级。从 Red Hat Enterprise Linux 7.3 开始，如果在设备配置中指定 <code>prio &quot;alua exclusive_pref_bit&quot;</code>，多路径将生成包含只使用 <code>pref</code> 字节集的路径组，并为该组设定最高优先级。<code>ontap</code>：为 NetApp 阵列生成路径优先权。<code>rdac</code>：为 LSI/Engenio RDAC 控制程序生成路径优先权。<code>hp_sw</code>：为 Compaq/HP 控制程序在激活/等待模式中生成路径优先权。<code>hds</code>：为 Hitachi HDS Modular 存储阵列生成路径优先权。默认值为 <code>const</code>。</td>
</tr>
<tr>
<td><code>features</code></td>
<td>多路径设备的默认额外功能，使用以下格式：”<em>number_of_features_plus_arguments</em> <em>feature1</em> …”。<code>features</code> 可能的值包括：<code>queue_if_no_path</code>，与将 <code>no_path_retry</code> 设置为 <code>queue</code> 相同。<code>retain_attached_hw_handler</code>：若此参数值被设为 <code>yes</code>，并且 SCSI 层已经为路径设备添加了硬件控制程序，multipath 将不会强制设备使用 <code>multipath.conf</code> 文件指定的 <code>hardware_handler</code>。若 SCSI 层没有添加硬件控制程序，multipath 仍然会使用已配置的硬件控制程序。默认值为 <code>no</code>。<code>pg_init_retries *n*</code>：路径组初始化重试，失败前最多重试 <em>n</em> 次，1 &lt;= <em>n</em> &lt;= 50。<code>pg_init_delay_msecs *n*</code>：在路径组初始化重试的间隔，等待 <em>n</em> 毫秒，0 &lt;= <em>n</em> &lt;= 60000。</td>
</tr>
<tr>
<td><code>path_checker</code></td>
<td>指定用于决定路径状态的默认方法，可能的值包括：<code>readsector0</code>：读取该设备的第一扇区。<code>tur</code>：在设备中执行 <code>TEST UNIT READY</code> 命令。<code>emc_clariion</code>：查询 EMC Clariion 具体 EVPD 页面 0xCO 以便决定路径。<code>hp_sw</code>：为使用 Active/Standby 固件的 HP 存储阵列检查路径状态。<code>rdac</code>：检查 LSI/Engenio RDAC 储存控制器的路径状态。<code>directio</code>：使用直接 I/O 读取第一个扇区。默认值为 <code>directio</code>。</td>
</tr>
<tr>
<td><code>failback</code></td>
<td>管理路径组群出错切换。<code>immediate</code> 值指定立即恢复到包含活跃路径的最高级别路径组群。<code>manual</code> 值指定不需要立即恢复，只有在操作者干预的情况下会发生恢复。<code>followover</code> 值指定当路径组的第一个路径成为活跃路径时应执行自动恢复。这可让节点在另一个节点请求故障修复时不会自动恢复。大于 0 的数字值指定推迟出错切换，以秒表示。默认值为 <code>manual</code>。</td>
</tr>
<tr>
<td><code>rr_min_io</code></td>
<td>指定切换到当前路径组的下一个路径前路由到该路径的 I/O 请求数。这个设置值用于运行内核为 2.6.31 之前的系统。使用新版本的系统应使用 <code>rr_min_io_rq</code>。默认值为 1000。</td>
</tr>
<tr>
<td><code>rr_min_io_rq</code></td>
<td>使用 request-based device-mapper-multipath 指定切换到当前路径组的下一个路径前路由到该路径的 I/O 请求数。这个设置值用于运行当前内核的系统。在使用内核 2.6.31 版本之前的系统应使用 <code>rr_min_io</code>。默认值为 1。</td>
</tr>
<tr>
<td><code>rr_weight</code></td>
<td>如果将其设为 <code>priorities</code>，就不会在调用 <code>selector</code> 选择下一个路径前向路径发送 <code>rr_min_io</code> 请求，而是由 <code>rr_min_io</code> 乘以路径优先权决定发送的请求数，即由 <code>prio</code> 功能决定。如果将其设定为 <code>uniform</code>，则所有路径都有相同的加权。默认值为 <code>uniform</code>。</td>
</tr>
<tr>
<td><code>no_path_retry</code></td>
<td>此属性的数字值指定了系统在禁用队列前，应该尝试使用失败路径的次数。值为 <code>fail</code> 意味着立即失败，无需排队。值为 <code>queue</code> 意味着路径固定前不会停止排队。默认值为 0。</td>
</tr>
<tr>
<td><code>user_friendly_names</code></td>
<td>如果将其设为 <code>yes</code>，即指定该系统应该使用文件 <code>/etc/multipath/bindings</code> 为该多路径分配一个持久且唯一的别名，格式为 <code>mpath</code><em>n</em>。如果设定为 <code>no</code>，即指定该系统应使用 WWID 作为该多路径的别名。在这两种情况下，您在这里指定的数值将被您在配置文件 <code>multipaths</code> 部分指定的具体设备别名覆盖。默认值为 <code>no</code>。</td>
</tr>
<tr>
<td><code>queue_without_daemon</code></td>
<td>如果将其设为 <code>no</code>，则 <code>multipathd</code> 守护程序将会在其关闭时禁用所有设备队列。默认值为 <code>no</code>。</td>
</tr>
<tr>
<td><code>flush_on_last_del</code></td>
<td>如果将其设为 <code>yes</code>，那么 <code>multipathd</code> 守护程序将会在设备的最后一条路径被删除时禁用队列。默认值为 <code>no</code>。</td>
</tr>
<tr>
<td><code>max_fds</code></td>
<td>设定 multipath 可以打开的文件提示符以及 <code>multipathd</code> 守护进程的最大值。这与 <code>ulimit -n</code> 命令效果一致。从 Red Hat Enterprise Linux 6.3 开始，默认值为 <code>max</code>，该值将该系统限制到 <code>/proc/sys/fs/nr_open</code>。对其较早的版本，如果没有设定这个值，则使用调用进程作为打开文件提示符的最大值，通常为 1024。安全起见，如果该数值大于 1024，应将其设定为路径最大值+32。</td>
</tr>
<tr>
<td><code>checker_timeout</code></td>
<td>路径检查器和排序器执行带显式超时的 SCSI 命令的超时时间，以秒为单位。默认值为 <code>sys/block/sd*x*/device/timeout</code> 中指定的值。</td>
</tr>
<tr>
<td><code>fast_io_fail_tmo</code></td>
<td>在 FC 远程端口发现问题后，无法在那个远程端口设备中执行 I/O 前 SCSI 层要等待的时间。默认值应小于 <code>dev_loss_tmo</code> 值。将其设定为 <code>off</code> 则会禁用超时。默认值由该操作系统决定。</td>
</tr>
<tr>
<td><code>dev_loss_tmo</code></td>
<td>在 FC 远程端口发现问题后，到从该系统中删除它之前 SCSI 层要等待的时间。将其设定为无限，则会将其设定为 2147483647 秒，或者 68 年。默认值由该操作系统决定。</td>
</tr>
<tr>
<td><code>hw_string_match</code></td>
<td><code>multipath.conf</code> 文件 <code>devices</code> 部分中的每个设备配置都将会创建自己的设备配置，或是修改某个内置设备配置。如果 <code>hw_string_match</code> 被设为 <code>yes</code>，那么如果某用户设备配置中的供应商、产品和修订字符串与内置设备配置中的字符串完全匹配，则该用户配置选项就会修改内置配置。否则该用户设备配置会被视为新配置。如果 <code>hw_string_match</code> 被设为 <code>no</code>，那么就会使用正则表达式匹配，而不使用字符串匹配。默认情况下会将 <code>hw_string_match</code> 设定为 <code>no</code>。</td>
</tr>
<tr>
<td><code>retain_attached_hw_handler</code></td>
<td>如果此参数被设为 <code>yes</code>，并且 SCSI 层已经为路径设备附加了硬件处理程序，那么 multipath 将不会强制设备使用 <code>multipath.conf</code> 文件指定的 <code>hardware_handler</code>。如果 SCSI 层未附加硬件处理程序，multipath 将会继续使用其配置的硬件处理程序。默认值为 <code>no</code>。</td>
</tr>
<tr>
<td><code>detect_prio</code></td>
<td>如果将此参数设定为 <code>yes</code>，multipath 将会首先检查该设备是否支持 ALUA。如果支持，则自动为该设备分配 <code>alua</code> 排序器；如果不支持，则按惯例确定排序器。默认值为 <code>no</code>。</td>
</tr>
<tr>
<td><code>uid_attribute</code></td>
<td>提供唯一路径标识符。默认值为 <code>ID_SERIAL</code>。</td>
</tr>
<tr>
<td><code>force_sync</code></td>
<td>（从 Red Hat Enterprise Linux 7.1 开始）如果将其设定为“yes”，则会阻止路径检查程序在异步（async）模式下运行。这意味着每次只能运行一个检查程序。这对同时运行很多 <code>multipathd</code> 检查程序而造成明显 CPU 负担过重时会有帮助。默认值为 <code>no</code>。</td>
</tr>
<tr>
<td><code>delay_watch_checks</code></td>
<td>（从 Red Hat Enterprise Linux Release 7.2 开始）如果将其设定为大于 0 的值，<code>multipathd</code> 守护进程将监视最近有效的路径，并执行指定数量的检查。如果在监视期间这些路径再次变为无法使用，则不会在这些路径下一次可用时就使用它们，直到连续检查使用 <code>delay_wait_checks</code> 指定的次数后它们都可用为止。 这样可防止将那些可能不太可靠的路径在上线后立即投入使用。默认值为 <code>no</code>。</td>
</tr>
<tr>
<td><code>delay_wait_checks</code></td>
<td>（从 Red Hat Enterprise Linux 7.2 开始）如果将其设定为大于 0 的值，则最近重新上线的设备在由 <code>delay_watch_checks</code> 指定的检查次数内再次无法使用后，那么它下一次上线后就不会被标记并延迟，并在经过使用 <code>delay_watch_checks</code> 指定的检查次数后方可使用。默认值为 <code>no</code>。</td>
</tr>
<tr>
<td><code>ignore_new_boot_devs</code></td>
<td>（从 Red Hat Enterprise Linux 7.2 开始）如果设定为 <code>yes</code>，在引导初期该节点仍处于 <code>initramfs</code> 文件系统中时，multipath 不会创建任何 WWID 属于 <code>/etc/multipath/wwids</code> 的 <code>initramfs copy</code> 中的设备。当 multipath 另外尝试在手册出现时未使用 <code>udev</code> 规则声明的设备中进行设置时，这个功能可用于在安装过程中引导。可将这个参数设定为 <code>yes</code> 或者 <code>no</code>。如果未设置，则默认将其设定为 <code>no</code>。</td>
</tr>
<tr>
<td><code>retrigger_tries</code>, <code>retrigger_delay</code></td>
<td>（从 Red Hat Enterprise Linux 7.2 开始）如果 <code>udev</code> 无法完成原始命令让多路径无法使用该设备，则联合使用 <code>retrigger_tries</code> 和 <code>retrigger_delay</code> 参数，以便 <code>multipathd</code> 命令可以重新激发 uevent。<code>retrigger_tries</code> 参数为没有完全设置的设备设定多路径尝试重新触发 <code>uevent</code> 的次数。<code>retrigger_delay</code> 参数设定两次重试之间的秒数。这两个选项均接受大于或等于 0 的数字。将 <code>retrigger_delay</code> 设定为 0 就是禁用重试。将 <code>retrigger_delay</code> 参数设定为 0 可导致在路径检查器的下一次检查中重新启动 <code>uevent</code>。如果没有设定 <code>retrigger_tries</code> 参数，则会使用默认值 3。如果没有设定 <code>retrigger_delay</code> 参数，则会使用默认值 10。</td>
</tr>
<tr>
<td><code>new_bindings_in_boot</code></td>
<td>（从 Red Hat Enterprise Linux Release 7.2 开始）使用 <code>new_bindings_in_boot</code> 参数在 <code>initramfs</code> 文件系统中保持已被常规文件系统中绑定文件耗尽的 <code>user_friendly_name</code>。这样会造成问题，因为只有重建 <code>initramfs</code> 文件系统时才会将 <code>initramfs</code> 文件系统中的 <code>user_friendly_names</code> 绑定与常规文件系统中的绑定同步。当将此参数设定为 <code>no</code> 后，多路经不会在 <code>initramfs</code> 文件系统中创建任何新绑定。如果某个设备中原来没有在 <code>/etc/multipath/bindings</code> 的 <code>initramfs</code>副本中有任何绑定，多路经会使用其 WWID 作为别名，而不是为其分配 <code>user_friendly_name</code>。之后在引导后，该节点会挂载至常规文件系统，多路径会为该设备分配 <code>user_friendly_name</code>。可将该参数设定为 <code>yes</code>或者 <code>no</code>。如果未设定，则默认使用 <code>no</code>。</td>
</tr>
<tr>
<td><code>config_dir</code></td>
<td>（从 Red Hat Enterprise Linux Release 7.2 开始）如果设定为 <code>&quot;&quot;</code> 以外的内容，多路径会按字母顺序搜索这些路径，查找以 “.conf” 结尾的文件，并从中读取配置信息，就如同该信息位于 <code>/etc/multipath.conf</code> 文件中一样。这样您就会在具体机器的配置文件以外有一个主配置文件。<code>config_dir</code> 参数必须为 <code>&quot;&quot;</code> 或者完全限定目录名。只能在主 <code>/etc/multipath.conf</code> 文件中设定这个参数，不能在由 <code>config_dir</code>文件自己指定的某个文件中设定这个参数。默认值为 <code>/etc/multipath/conf.d</code>。</td>
</tr>
<tr>
<td><code>deferred_remove</code></td>
<td>如果设定为 <code>yes</code>，则在删除最后一个路径设备时，multipathd 将会执行延期删除，而不是常规删除。这样就会保证如果执行常规删除且操作失败时某个多路径设备正在使用中，该设备会在最后一个用户关闭该设备时自动被删除。</td>
</tr>
<tr>
<td><code>log_checker_err</code></td>
<td>如果设定为 <code>once</code>，multipathd 会采用详细等级 2 记录第一个路径检查器错误。之后的所有错误都要在该设备恢复后采用详细等级 3 记录。如果设定为 <code>always</code>，multipathd 会一直使用详细等级 2 记录路径检查器错误。默认值为 <code>always</code>。</td>
</tr>
<tr>
<td><code>skip_kpartx</code></td>
<td>如果设定为 <code>yes</code>，<code>kpartx</code> 不会在该设备中自动创建分区。这样即使该设备有分区表，也可以允许用户在不创建分区的情况下创建多路径设备。这个选项的默认值为 <code>no</code>。</td>
</tr>
</tbody>
</table>
</div>
<h2 id="多路径设备配置属性"><a href="#多路径设备配置属性" class="headerlink" title="多路径设备配置属性"></a>多路径设备配置属性</h2><p>表 4.2 “多路径属性”显示在 <code>multipath.conf</code> 配置文件 <code>multipaths</code> 部分中可为每个特定多路径设备设置的属性。这些属性只适用于一个指定的 multipath。这些默认属性可供 DM Multipath 使用，并且能覆盖 <code>multipath.conf</code> 文件中 <code>defaults</code> 和 <code>devices</code> 部分设置的属性。</p>
<p>⁠</p>
<p><strong>表 4.2. 多路径属性</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>wwid</code></td>
<td>指定 <code>multipath</code> 属性采用的多路径设备的 WWID。这个参数在 <code>multipath.conf</code> 文件的这个部分是必须的。</td>
</tr>
<tr>
<td><code>alias</code></td>
<td>指定使用 <code>multipath</code> 属性的多路径设备的符号名称。如果您使用的是 <code>user_friendly_names</code>，请必要将其设定为 <code>mpath*n*</code>，这样可能会与自动分配的用户友好名称冲突，进而给出不正确的设备节点名称。</td>
</tr>
<tr>
<td><code>path_grouping_policy</code></td>
<td>指定用于未指定路径的默认路径分组策略，可能的值包括：<code>failover</code> = 每个优先组群有一个路径<code>multibus</code> = 所有有效路径在一个优先组群中<code>group_by_serial</code> = 每个检测到的系列号有一个优先组群<code>group_by_prio</code> = 每个路径优先值有一个优先组群<code>group_by_node_name</code> = 每个目标节点名有一个优先组群</td>
</tr>
<tr>
<td><code>path_selector</code></td>
<td>指定用来决定下一个 I/O 操作所使用路径的默认算法。可能的值包括：<code>round-robin 0</code>：在路径组中循环每个路径，向每个路径发送同样数量的 I/O。<code>queue-length 0</code>：将下一组 I/O 发送到具有最少未处理 I/O 请求的路径。<code>service-time 0</code>：将下一组 I/O 发送到具有最短预计服务时间的路径，这是由未处理 I/O 的总量除以每个路径的相对流量决定的。</td>
</tr>
<tr>
<td><code>failback</code></td>
<td>管理路径组群出错切换。<code>immediate</code> 值指定立即恢复到包含活跃路径的最高级别路径组群。<code>manual</code> 值指定不需要立即恢复，只有在操作者干预的情况下会发生恢复。<code>followover</code> 值指定当路径组的第一个路径成为活跃路径时应执行自动恢复。这可让节点在另一个节点请求故障修复时不会自动恢复。大于 0 的数字值指定推迟出错切换，以秒表示。</td>
</tr>
<tr>
<td><code>prio</code></td>
<td>指定要获得路径优先值所需调用的默认程序及参数。例如：SPC-3 中的 ALUA 字节提供了一个可改变的 <code>prio</code> 值。可能的值包括：<code>const</code>：为所有路径设定优先权 1。<code>emc</code>：为 EMC 阵列生成路径优先权。<code>alua</code>：根据 SCSI-3 ALUA 设置生成路径有限级。从 Red Hat Enterprise Linux 7.3 开始，如果在设备配置中指定 <code>prio &quot;alua exclusive_pref_bit&quot;</code>，多路径将生成包含只使用 <code>pref</code> 字节集的路径组，并为该组设定最高优先级。<code>ontap</code>：为 NetApp 阵列生成路径优先权。<code>rdac</code>：为 LSI/Engenio RDAC 控制程序生成路径优先权。<code>hp_sw</code>：为 Compaq/HP 控制程序在激活/等待模式中生成路径优先权。<code>hds</code>：为 Hitachi HDS Modular 存储阵列生成路径优先权。</td>
</tr>
<tr>
<td><code>features</code></td>
<td>多路径设备的默认额外功能，使用以下格式：”<em>number_of_features_plus_arguments</em> <em>feature1</em> …”。<code>features</code> 可能的值包括：<code>queue_if_no_path</code>，与将 <code>no_path_retry</code> 设置为 <code>queue</code> 相同。<code>retain_attached_hw_handler</code>：若此参数值被设为 <code>yes</code>，并且 SCSI 层已经为路径设备添加了硬件控制程序，multipath 将不会强制设备使用 <code>multipath.conf</code> 文件指定的 <code>hardware_handler</code>。若 SCSI 层没有添加硬件控制程序，multipath 仍然会使用已配置的硬件控制程序。默认值为 <code>no</code>。<code>pg_init_retries *n*</code>：路径组初始化重试，失败前最多重试 <em>n</em> 次，1 &lt;= <em>n</em> &lt;= 50。<code>pg_init_delay_msecs *n*</code>：在路径组初始化重试的间隔，等待 <em>n</em> 毫秒，0 &lt;= <em>n</em> &lt;= 60000。</td>
</tr>
<tr>
<td><code>no_path_retry</code></td>
<td>此属性的数字值指定了系统在禁用队列前，应该尝试使用失败路径的次数。值为 <code>fail</code> 意味着立即失败，无需排队。值为 <code>queue</code> 意味着路径固定前不会停止排队。</td>
</tr>
<tr>
<td><code>rr_min_io</code></td>
<td>指定切换到当前路径组的下一个路径前路由到该路径的 I/O 请求数。这个设置值用于运行内核为 2.6.31 之前的系统。使用新版本的系统应使用 <code>rr_min_io_rq</code>。默认值为 1000。</td>
</tr>
<tr>
<td><code>rr_min_io_rq</code></td>
<td>使用 request-based device-mapper-multipath 指定切换到当前路径组的下一个路径前路由到该路径的 I/O 请求数。这个设置值用于运行当前内核的系统。在使用内核 2.6.31 版本之前的系统应使用 <code>rr_min_io</code>。默认值为 1。</td>
</tr>
<tr>
<td><code>rr_weight</code></td>
<td>如果将其设为 <code>priorities</code>，就不会在调用 <code>selector</code> 选择下一个路径前向路径发送 <code>rr_min_io</code> 请求，而是由 <code>rr_min_io</code> 乘以路径优先权决定发送的请求数，即由 <code>prio</code> 功能决定。如果将其设定为 <code>uniform</code>，则所有路径都有相同的加权。</td>
</tr>
<tr>
<td><code>flush_on_last_del</code></td>
<td>如果将其设为 <code>yes</code>，那么当设备的最后一条路径被删除时，multipath 将会禁用队列。</td>
</tr>
<tr>
<td><code>user_friendly_names</code></td>
<td>如果将其设为 <code>yes</code>，即指定该系统应该使用文件 <code>/etc/multipath/bindings</code> 为该多路径分配一个持久且唯一的别名，格式为 <code>mpath</code><em>n</em>。如果设定为 <code>no</code>，即指定该系统应使用 WWID 作为该多路径的别名。在这两种情况下，您在这里指定的数值将被您在配置文件 <code>multipaths</code> 部分指定的具体设备别名覆盖。</td>
</tr>
<tr>
<td><code>delay_watch_checks</code></td>
<td>（从 Red Hat Enterprise Linux Release 7.2 开始）如果将其设定为大于 0 的值，<code>multipathd</code> 守护进程将监视最近有效的路径，并执行指定数量的检查。如果在监视期间这些路径再次变为无法使用，则不会在这些路径下一次可用时就使用它们，直到连续检查使用 <code>delay_wait_checks</code> 指定的次数后它们都可用为止。 这样可防止将那些可能不太可靠的路径在上线后立即投入使用。</td>
</tr>
<tr>
<td><code>delay_wait_checks</code></td>
<td>（从 Red Hat Enterprise Linux 7.2 开始）如果将其设定为大于 0 的值，则最近重新上线的设备在由 <code>delay_watch_checks</code> 指定的检查次数内再次无法使用后，那么它下一次上线后就不会被标记并延迟，并在经过使用 <code>delay_watch_checks</code> 指定的检查次数后方可使用。</td>
</tr>
<tr>
<td><code>deferred_remove</code></td>
<td>如果设定为 <code>yes</code>，则在删除最后一个路径设备时，multipathd 将会执行延期删除，而不是常规删除。这样就会保证如果执行常规删除且操作失败时某个多路径设备正在使用中，该设备会在最后一个用户关闭该设备时自动被删除。</td>
</tr>
<tr>
<td><code>skip_kpartx</code></td>
<td>如果设定为 <code>yes</code>，<code>kpartx</code> 不会在该设备中自动创建分区。这样即使该设备有分区表，也可以允许用户在不创建分区的情况下创建多路径设备。</td>
</tr>
</tbody>
</table>
</div>
<p>以下示例显示在配置文件中为两个特定多路径设备指定的多路径属性。第一个设备的 WWID 为 <code>3600508b4000156d70001200000b0000</code>，符号名称为 <code>yellow</code>。</p>
<p>示例中第二个多路径设备的 WWID 为 <code>1DEC_____321816758474</code>，符号名称为 <code>red</code>。在这个示例中，<code>rr_weight</code> 属性被设为 <code>priorities</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">multipaths &#123;</span><br><span class="line">       multipath &#123;</span><br><span class="line">              wwid                  3600508b4000156d70001200000b0000</span><br><span class="line">              <span class="built_in">alias</span>                 yellow</span><br><span class="line">              path_grouping_policy  multibus</span><br><span class="line">              path_selector         <span class="string">"round-robin 0"</span></span><br><span class="line">              failback              manual</span><br><span class="line">              rr_weight             priorities</span><br><span class="line">              no_path_retry         5</span><br><span class="line">       &#125;</span><br><span class="line">       multipath &#123;</span><br><span class="line">              wwid                  1DEC_____321816758474</span><br><span class="line">              <span class="built_in">alias</span>                 red</span><br><span class="line">              rr_weight             priorities</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="配置文件设备"><a href="#配置文件设备" class="headerlink" title="配置文件设备"></a>配置文件设备</h2><p>表 4.3 “设备属性”显示您可以为 <code>multipath.conf</code> 配置文件 <code>devices</code> 部分的每个独立储存设备能设置的属性。DM Multipath 会使用这些属性，除非它们被 <code>multipath.conf</code> 文件 <code>multipaths</code> 部分为包含该设备的路径所指定的属性覆盖。这些属性会覆盖 <code>multipath.conf</code> 文件 <code>defaults</code> 部分设定的属性。</p>
<p>多路径配置中默认包含许多支持 multipath 的设备。如需了解默认配置值（包括支持的设备）的相关信息，请运行以下命令之一。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># multipathd show config</span></span><br><span class="line"><span class="comment"># multipath -t</span></span><br></pre></td></tr></table></figure>
<p>您可能不需要为这些设备修改默认值，但如果您想要修改，可以通过在配置文件中添加条目来覆盖默认值。您可以为设备复制 <code>multipathd show config</code> 命令显示的设备配置默认值，并覆盖您想要修改的值。</p>
<p>如需在配置文件的这部分添加没有默认自动配置的设备，您需要设置 <code>vendor</code> 和 <code>product</code> 参数。您能在 <code>/sys/block/*device_name*/device/vendor</code> 和 <code>/sys/block/*device_name*/device/model</code>中找到这些值，其中 <em>device_name</em> 是要进行多路径操作的设备，示例如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /sys/block/sda/device/vendor</span></span><br><span class="line">WINSYS  </span><br><span class="line"><span class="comment"># cat /sys/block/sda/device/model</span></span><br><span class="line">SF2372</span><br></pre></td></tr></table></figure>
<p>要指定的附加参数要视具体设备而定。如果设备是主动/主动模式，您通常不需要设置附加参数。您可能想要将 <code>path_grouping_policy</code> 设为 <code>multibus</code>。其它您可能需要设定的参数有 <code>no_path_retry</code>和 <code>rr_min_io</code>，详见 表 4.3 “设备属性”</p>
<p>如果设备是主动/被动模式，但它会自动将路径切换到被动路径，那么您需要将检查器功能改为不需向路径发送 I/O 来测试其是否工作（否则，您的设备将一直进行出错冗余）的功能。这几乎意味着您将 <code>path_checker</code> 设为 <code>tur</code>。这对所有支持 Test Unit Ready 命令的 SCSI 设备都适用。</p>
<p>如果该设备需要一个特殊的命令切换路径，那么为多路径配置此设备需要硬件处理器内核模块。当前的硬件处理器是 <code>emc</code>。如果这样还不能满足您的设备，则您可能无法为多路径配置该设备。</p>
<p>⁠</p>
<p><strong>表 4.3. 设备属性</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>vendor</code></td>
<td>指定 <code>device</code> 采用的存储设备的零售商名称，例如 <code>COMPAQ</code>。</td>
</tr>
<tr>
<td><code>product</code></td>
<td>指定 <code>device</code> 属性使用的存储设备产品名，比如 <code>HSV110 (C) COMPAQ</code>。</td>
</tr>
<tr>
<td><code>revision</code></td>
<td>指定存储设备的产品修订识别程序。</td>
</tr>
<tr>
<td><code>product_blacklist</code></td>
<td>根据产品指定用来将设备列入黑名单的正则表达式。</td>
</tr>
<tr>
<td><code>alias_prefix</code></td>
<td>这个设备类型使用的 <code>user_friendly_names</code> 前缀，而不是默认的”mpath”。</td>
</tr>
<tr>
<td><code>hardware_handler</code></td>
<td>指定将在切换路径组群或者处理 I/O 错误时用来执行硬件具体动作的模块。可能的值包括：<code>1 emc</code>：EMC 存储阵列的硬件处理程序。<code>1 alua</code>：SCSI-3 ALUA 阵列的硬件处理程序。<code>1 hp_sw</code>：Compaq/HP 控制器的硬件处理程序。<code>1 rdac</code>：LSI/Engenio RDAC 控制器的硬件处理程序。</td>
</tr>
<tr>
<td><code>path_grouping_policy</code></td>
<td>指定用于未指定路径的默认路径分组策略，可能的值包括：<code>failover</code> = 每个优先组群有一个路径<code>multibus</code> = 所有有效路径在一个优先组群中<code>group_by_serial</code> = 每个检测到的系列号有一个优先组群<code>group_by_prio</code> = 每个路径优先值有一个优先组群<code>group_by_node_name</code> = 每个目标节点名有一个优先组群</td>
</tr>
<tr>
<td><code>path_selector</code></td>
<td>指定用来决定下一个 I/O 操作所使用路径的默认算法。可能的值包括：<code>round-robin 0</code>：在路径组中循环每个路径，向每个路径发送同样数量的 I/O。<code>queue-length 0</code>：将下一组 I/O 发送到具有最少未处理 I/O 请求的路径。<code>service-time 0</code>：将下一组 I/O 发送到具有最短预计服务时间的路径，这是由未处理 I/O 的总量除以每个路径的相对流量决定的。</td>
</tr>
<tr>
<td><code>path_checker</code></td>
<td>指定用于决定路径状态的默认方法，可能的值包括：<code>readsector0</code>：读取该设备的第一扇区。<code>tur</code>：在该设备中执行 <code>TEST UNIT READY</code>。<code>emc_clariion</code>：查询 EMC Clariion 具体 EVPD 页面 0xCO 以便决定路径。<code>hp_sw</code>：为使用 Active/Standby 固件的 HP 存储阵列检查路径状态。<code>rdac</code>：为 LSI/Engenio RDAC 存储控制器检查路径状态。<code>directio</code>：使用直接 I/O 读取第一个扇区。</td>
</tr>
<tr>
<td><code>features</code></td>
<td>多路径设备的默认额外功能，使用以下格式：”<em>number_of_features_plus_arguments</em> <em>feature1</em> …”。<code>features</code> 可能的值包括：<code>queue_if_no_path</code>，与将 <code>no_path_retry</code> 设置为 <code>queue</code> 相同。<code>retain_attached_hw_handler</code>：如果此参数被设为 <code>yes</code>，并且 SCSI 层已经为路径设备附加硬件处理程序，multipath 将不会强制设备使用 <code>multipath.conf</code> 文件指定的 <code>hardware_handler</code>。如果 SCSI 层未附加硬件处理程序，multipath 将会继续使用配置的硬件处理程序。<code>pg_init_retries *n*</code>：路径组初始化重试，失败前最多重试 <em>n</em> 次，1 &lt;= <em>n</em> &lt;= 50。<code>pg_init_delay_msecs *n*</code>：在路径组初始化重试的间隔，等待 <em>n</em> 毫秒，0 &lt;= <em>n</em> &lt;= 60000。</td>
</tr>
<tr>
<td><code>prio</code></td>
<td>指定要获得路径优先值所需调用的默认程序及参数。例如：SPC-3 中的 ALUA 字节提供了一个可改变的 <code>prio</code> 值。可能的值包括：<code>const</code>：为所有路径设定优先权 1。<code>emc</code>：为 EMC 阵列生成路径优先权。<code>alua</code>：根据 SCSI-3 ALUA 设置生成路径有限级。从 Red Hat Enterprise Linux 7.3 开始，如果在设备配置中指定 <code>prio &quot;alua exclusive_pref_bit&quot;</code>，多路径将生成包含只使用 <code>pref</code> 字节集的路径组，并为该组设定最高优先级。<code>ontap</code>：为 NetApp 阵列生成路径优先权。<code>rdac</code>：为 LSI/Engenio RDAC 控制程序生成路径优先权。<code>hp_sw</code>：为 Compaq/HP 控制程序在激活/等待模式中生成路径优先权。<code>hds</code>：为 Hitachi HDS Modular 存储阵列生成路径优先权。</td>
</tr>
<tr>
<td><code>failback</code></td>
<td>管理路径组群出错切换。<code>immediate</code> 值指定立即恢复到包含活跃路径的最高级别路径组群。<code>manual</code> 值指定不需要立即恢复，只有在操作者干预的情况下会发生恢复。<code>followover</code> 值指定当路径组的第一个路径成为活跃路径时应执行自动恢复。这可让节点在另一个节点请求故障修复时不会自动恢复。大于 0 的数字值指定推迟出错切换，以秒表示。</td>
</tr>
<tr>
<td><code>rr_weight</code></td>
<td>如果将其设为 <code>priorities</code>，就不会在调用 <code>selector</code> 选择下一个路径前向路径发送 <code>rr_min_io</code> 请求，而是由 <code>rr_min_io</code> 乘以路径优先权决定发送的请求数，即由 <code>prio</code> 功能决定。如果将其设定为 <code>uniform</code>，则所有路径都有相同的加权。</td>
</tr>
<tr>
<td><code>no_path_retry</code></td>
<td>此属性的数字值指定了系统在禁用队列前，应该尝试使用失败路径的次数。值为 <code>fail</code> 意味着立即失败，无需排队。值为 <code>queue</code> 意味着路径固定前不会停止排队。</td>
</tr>
<tr>
<td><code>rr_min_io</code></td>
<td>指定切换到当前路径组的下一个路径前路由到该路径的 I/O 请求数。这个设置值用于运行内核为 2.6.31 之前的系统。使用新版本的系统应使用 <code>rr_min_io_rq</code>。默认值为 1000。</td>
</tr>
<tr>
<td><code>rr_min_io_rq</code></td>
<td>使用 request-based device-mapper-multipath 指定切换到当前路径组的下一个路径前路由到该路径的 I/O 请求数。这个设置值用于运行当前内核的系统。在使用内核 2.6.31 版本之前的系统应使用 <code>rr_min_io</code>。默认值为 1。</td>
</tr>
<tr>
<td><code>fast_io_fail_tmo</code></td>
<td>在 FC 远程端口发现问题后，无法在那个远程端口设备中执行 I/O 前 SCSI 层要等待的时间。默认值应小于 <code>dev_loss_tmo</code> 值。将其设定为 <code>off</code> 则会禁用超时。</td>
</tr>
<tr>
<td><code>dev_loss_tmo</code></td>
<td>在 FC 远程端口发现问题后，到从该系统中删除它之前 SCSI 层要等待的时间。将其设定为无限，则会将其设定为 2147483647 秒，或者 68 年。</td>
</tr>
<tr>
<td><code>flush_on_last_del</code></td>
<td>如果被设为 <code>yes</code>，当设备的最后一条路径被删除时，<code>multipathd</code> 守护程序将会禁用队列。</td>
</tr>
<tr>
<td><code>user_friendly_names</code></td>
<td>如果将其设为 <code>yes</code>，即指定该系统应该使用文件 <code>/etc/multipath/bindings</code> 为该多路径分配一个持久且唯一的别名，格式为 <code>mpath</code><em>n</em>。如果设定为 <code>no</code>，即指定该系统应使用 WWID 作为该多路径的别名。在这两种情况下，您在这里指定的数值将被您在配置文件 <code>multipaths</code> 部分指定的具体设备别名覆盖。默认值为 <code>no</code>。</td>
</tr>
<tr>
<td><code>retain_attached_hw_handler</code></td>
<td>如果此参数被设为 <code>yes</code>，并且 SCSI 层已经为路径设备附加了硬件处理程序，那么 multipath 将不会强制设备使用 <code>multipath.conf</code> 文件指定的 <code>hardware_handler</code>。如果 SCSI 层未附加硬件处理程序，multipath 将会继续使用其配置的硬件处理程序。默认值为 <code>no</code>。</td>
</tr>
<tr>
<td><code>detect_prio</code></td>
<td>如果被设为 <code>yes</code>，multipath 将会首先检查设备是否支持 ALUA。若支持，将会自动为设备分配 <code>alua</code> 排序器；若不支持，将会按惯例确定排序器。</td>
</tr>
<tr>
<td><code>uid_attribute</code></td>
<td>提供唯一路径标识符。</td>
</tr>
<tr>
<td><code>delay_watch_checks</code></td>
<td>（从 Red Hat Enterprise Linux Release 7.2 开始）如果将其设定为大于 0 的值，<code>multipathd</code> 守护进程将监视最近有效的路径，并执行指定数量的检查。如果在监视期间这些路径再次变为无法使用，则不会在这些路径下一次可用时就使用它们，直到连续检查使用 <code>delay_wait_checks</code> 指定的次数后它们都可用为止。 这样可防止将那些可能不太可靠的路径在上线后立即投入使用。</td>
</tr>
<tr>
<td><code>delay_wait_checks</code></td>
<td>（从 Red Hat Enterprise Linux 7.2 开始）如果将其设定为大于 0 的值，则最近重新上线的设备在由 <code>delay_watch_checks</code> 指定的检查次数内再次无法使用后，那么它下一次上线后就不会被标记并延迟，并在经过使用 <code>delay_watch_checks</code> 指定的检查次数后方可使用。</td>
</tr>
<tr>
<td><code>deferred_remove</code></td>
<td>如果设定为 <code>yes</code>，则在删除最后一个路径设备时，multipathd 将会执行延期删除，而不是常规删除。这样就会保证如果执行常规删除且操作失败时某个多路径设备正在使用中，该设备会在最后一个用户关闭该设备时自动被删除。</td>
</tr>
<tr>
<td><code>skip_kpartx</code></td>
<td>如果设定为 <code>yes</code>，<code>kpartx</code> 不会在该设备中自动创建分区。这样即使该设备有分区表，也可以允许用户在不创建分区的情况下创建多路径设备。</td>
</tr>
</tbody>
</table>
</div>
<p>以下示例显示了多路径配置文件的 <code>device</code> 条目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#	&#125;</span></span><br><span class="line"><span class="comment">#	device &#123;</span></span><br><span class="line"><span class="comment">#		vendor			"COMPAQ  "</span></span><br><span class="line"><span class="comment">#		product			"MSA1000         "</span></span><br><span class="line"><span class="comment">#		path_grouping_policy	multibus</span></span><br><span class="line"><span class="comment">#		path_checker		tur</span></span><br><span class="line"><span class="comment">#		rr_weight		priorities</span></span><br><span class="line"><span class="comment">#	&#125;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="第-5-章-DM-MULTIPATH-管理及故障排除"><a href="#第-5-章-DM-MULTIPATH-管理及故障排除" class="headerlink" title="第 5 章 DM MULTIPATH 管理及故障排除"></a>第 5 章 DM MULTIPATH 管理及故障排除</h1><p>本章提供了在运行的系统中管理 DM Multipath 的相关信息。</p>
<h2 id="使用多路径帮助程序（MULTIPATH-HELPER）自动生成配置文件"><a href="#使用多路径帮助程序（MULTIPATH-HELPER）自动生成配置文件" class="headerlink" title="使用多路径帮助程序（MULTIPATH HELPER）自动生成配置文件"></a>使用多路径帮助程序（MULTIPATH HELPER）自动生成配置文件</h2><p>可在 Red Hat Enterprise Linux 中使用 Multipath Helper 应用程序为多路径设备生成基本配置。该应用程序可使用自定义别名、设备黑名单和各个多路径设备的特别设定创建多路径配置。完成后，该应用程序可生成安装脚本，该脚本包含所选配置参数，并提供 <code>multipath.conf</code> 配置文件供检查。</p>
<p>可以在 <a href="https://access.redhat.com/labsinfo/multipathhelper" target="_blank" rel="noopener">https://access.redhat.com/labsinfo/multipathhelper</a> 找到 Multipath Helper 应用程序。</p>
<h2 id="重新定义在线多路径设备大小"><a href="#重新定义在线多路径设备大小" class="headerlink" title="重新定义在线多路径设备大小"></a>重新定义在线多路径设备大小</h2><p>如果要重新定义在线多路径设备，请按以下步骤操作。</p>
<ol>
<li><p>重新定义物理设备大小。</p>
</li>
<li><p>使用以下命令查找 LUN 路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multipath -l</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新定义路径大小。对于 SCSI 设备，在 <code>rescan</code> 文件中写入 1，以便让 SCSI 驱动器重新扫描，如以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/block/device_name/device/rescan</span><br></pre></td></tr></table></figure>
</li>
<li><p>如需重新定义多路径设备的大小，请执行 <code>multipathd resize</code> 命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multipathd -k<span class="string">'resize map mpatha'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>重新定义文件系统大小（假设没有使用 LVM 或者 DOS 分区）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resize2fs /dev/mapper/mpatha</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="将-ROOT-文件系统从单路径设备移动到多路径设备中"><a href="#将-ROOT-文件系统从单路径设备移动到多路径设备中" class="headerlink" title="将 ROOT 文件系统从单路径设备移动到多路径设备中"></a>将 ROOT 文件系统从单路径设备移动到多路径设备中</h2><p>如果在单路径设备中安装系统，并稍后在 root 文件系统中添加了另一个路径，则需要将 root 文件系统移动到多路径设备中。本小节记录了从单路径移动到多路径设备的过程。</p>
<p>安装 <code>device-mapper-multipath</code> 软件包后执行以下步骤：</p>
<ol>
<li><p>执行以下命令创建 <code>/etc/multipath.conf</code> 配置文件，载入多路径模块并将 <code>multipathd</code> 的 <code>chkconfig</code> 设定为 <code>on</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpathconf --<span class="built_in">enable</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果没有将 <code>find_multipaths</code> 参数配置为 <code>yes</code>，请编辑 <code>/etc/multipath.conf</code> 文件的 <code>blacklist</code> 和 <code>blacklist_exceptions</code> 部分所述。</p>
</li>
<li><p>要让 multipath 在 root 设备顶层发现多路径后尽快创建多路径设备，请输入以下命令。该命令还会确保 <code>find_multipaths</code> 会允许该设备，即使该设备只有一个路径。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multipath -a root_devname</span><br></pre></td></tr></table></figure>
<p>例如：如果 root 设备是 <code>/dev/sdb</code>，则请输入以下命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">multipath -a /dev/sdb</span><br><span class="line">wwid <span class="string">'3600d02300069c9ce09d41c4ac9c53200'</span> added</span><br></pre></td></tr></table></figure>
</li>
<li><p>为确定已正确设置配置文件，请输入 <code>multipath</code> 命令，并在输出结果中搜索使用以下格式的行。这表示该命令无法创建这个多路径设备。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">date  wwid: ignoring map</span><br></pre></td></tr></table></figure>
<p>例如，如果设备的 WWID 为 3600d02300069c9ce09d41c4ac9c53200，则会看到以下输出行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">multipath</span><br><span class="line">Oct 21 09:37:19 | 3600d02300069c9ce09d41c4ac9c53200: ignoring map</span><br></pre></td></tr></table></figure>
</li>
<li><p>要使用 <code>multipath</code> 重建 <code>initramfs</code> 文件系统，请执行附带以下选项的 <code>dracut</code> 命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dracut --force -H --add multipath</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭机器。</p>
</li>
<li><p>配置 FC 开关以便可在该机器中看到其他路径。</p>
</li>
<li><p>引导机器。</p>
</li>
<li><p>查看 root 文件系统（’/‘）是否在多路径设备中。</p>
</li>
</ol>
<h2 id="将-SWAP-文件系统从单路径设备移动到多路径设备中"><a href="#将-SWAP-文件系统从单路径设备移动到多路径设备中" class="headerlink" title="将 SWAP 文件系统从单路径设备移动到多路径设备中"></a>将 SWAP 文件系统从单路径设备移动到多路径设备中</h2><p>默认情况下会将 swap 设备设定为逻辑卷。将其配置 为多路径设备不需要特殊的操作，只要在由逻辑卷组构成的物理卷中设定多路径即可。如果 swap 设备不是 LVM 卷，却使用设备名称挂载，就可能需要编辑 <code>/etc/fstab</code> 文件将其转换为正确的多路径设备名称。</p>
<ol>
<li><p>运行 <code>/sbin/multipath</code> 命令使用 <code>-v3</code> 选项确定 swap 设备的 WWID 号。该命令的输出应该在路径列表中显示该 swap 设备。</p>
<p>可以在该命令输出中看到有以下格式的行，它代表 swap 设备：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WWID  H:B:T:L devname MAJOR:MINOR</span><br></pre></td></tr></table></figure>
<p>例如：如果在 <code>sda</code> 或其分区之一中设置 swap 文件系统，则会在输出中看到类似如下的行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">===== paths list =====</span><br><span class="line">...</span><br><span class="line">1ATA     WDC WD800JD-75MSA3                           WD-WMAM9F 1:0:0:0 sda 8:0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <code>/etc/multipath.conf</code> 文件中为 swap 设备配置别名。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">multipaths &#123;</span><br><span class="line">    multipath &#123;</span><br><span class="line">        wwid WWID_of_swap_device</span><br><span class="line">        <span class="built_in">alias</span> swapdev</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑 <code>/etc/fstab</code> 文件，并使用附带多路径设备的 root 设备替换旧的设备路径。</p>
<p>例如：如果在 <code>/etc/fstab</code> 文件中有以下条目：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/sda2 swap                    swap    defaults        0 0</span><br></pre></td></tr></table></figure>
<p>可将该条目更改如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/mapper/swapdev swap          swap    defaults        0 0</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="多路径守护进程"><a href="#多路径守护进程" class="headerlink" title="多路径守护进程"></a>多路径守护进程</h2><p>如果在进行多路径配置时遇到问题，则应该确定多路径守护进程正在运行，必须运行 <code>multipathd</code> 守护进程方可使用多路径设备。</p>
<h2 id="大量-LUN-造成的问题"><a href="#大量-LUN-造成的问题" class="headerlink" title="大量 LUN 造成的问题"></a>大量 LUN 造成的问题</h2><p>在某个节点中添加大量 LUN 时，使用多路径设备可明显延长 <code>udev</code> 设备管理器为其生成设备节点所消耗的时间。如果遇到这个问题，请在 <code>/etc/udev/rules.d/40-multipath.rules</code> 文件中删除以下行解决这个问题：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KERNEL!=<span class="string">"dm-[0-9]*"</span>, ACTION==<span class="string">"add"</span>, PROGRAM==<span class="string">"/bin/bash -c '/sbin/lsmod | /bin/grep ^dm_multipath'"</span>, RUN+=<span class="string">"/sbin/multipath -v0 %M:%m"</span></span><br></pre></td></tr></table></figure>
<p>这行会在每次向该节点中添加块设备时让 <code>udev</code> 设备管理器运行 <code>multipath</code>。即使删除了这一行，<code>multipathd</code> 守护进程仍将自动生成多路径设备，同时在引导附带多路径 root 文件系统节点的过程中仍会调用 <code>multipath</code>。唯一的变化就是没有运行 <code>multipathd</code> 守护进程不再自动生成多路径设备，对大多数多路径用户来说应该不是个问题。</p>
<h2 id="有-QUEUE-IF-NO-PATH-功能的问题"><a href="#有-QUEUE-IF-NO-PATH-功能的问题" class="headerlink" title="有 QUEUE_IF_NO_PATH 功能的问题"></a>有 QUEUE_IF_NO_PATH 功能的问题</h2><p>如果使用 <code>features &quot;1 queue_if_no_path&quot;</code> 配置多路径设备，那么所有采用 I/O 操作的进程都将被挂起直到恢复一个或者多个路径为止。要避免这种情况，请在 <code>/etc/multipath.conf</code> 文件中设定 <code>no_path_retry</code> <em>N</em> 参数（其中 <em>N</em> 是该系统应该重试某个路径的次数）。</p>
<p>如果需要使用 <code>features &quot;1 queue_if_no_path&quot;</code> 选项，且遇到这里提到的问题，请使用 <code>dmsetup</code>命令为特定 LUN 编辑运行时策略（就是说对该特定 LUN 来说所有路径都不可用）。例如：如果想要将多路径设备 <code>mpath2</code> 的策略从 <code>&quot;queue_if_no_path&quot;</code> 改为 <code>&quot;fail_if_no_path&quot;</code>，请执行以下命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dmsetup message mpathc 0 <span class="string">"fail_if_no_path"</span></span><br></pre></td></tr></table></figure>
<p>请注意：必须指定 <code>mpath</code><em>n</em> 别名而不是该路径。</p>
<h2 id="多路径命令输出"><a href="#多路径命令输出" class="headerlink" title="多路径命令输出"></a>多路径命令输出</h2><p>创建、修改或者列出多路径设备时，会显示当前设备设置状态，格式如下所示。</p>
<p>对于每个多路径设备：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action_if_any: <span class="built_in">alias</span> (wwid_if_different_from_alias) dm_device_name_if_known vendor,product size=size features=<span class="string">'features'</span> hwhandler=<span class="string">'hardware_handler'</span> wp=write_permission_if_known</span><br></pre></td></tr></table></figure>
<p>对与每个路径组群：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-+- policy=<span class="string">'scheduling_policy'</span> prio=prio_if_known status=path_group_status_if_known</span><br></pre></td></tr></table></figure>
<p>对于每个路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`- host:channel:id:lun devnode major:minor dm_status_if_known path_status online_status</span><br></pre></td></tr></table></figure>
<p>例如，多路径命令的输出可能是如下形式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">3600d0230000000000e13955cc3757800 dm-1 WINSYS,SF2372</span><br><span class="line">size=269G features=<span class="string">'0'</span> hwhandler=<span class="string">'0'</span> wp=rw</span><br><span class="line">|-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=active</span><br><span class="line">| `- 6:0:0:0 sdb 8:16  active ready  running</span><br><span class="line">`-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=enabled</span><br><span class="line">  `- 7:0:0:0 sdf 8:80  active ready  running</span><br></pre></td></tr></table></figure>
<p>如果该路径已经启用并准备好执行 I/O，那么路径的状态就是 <code>ready</code> 或者 <code>ghost</code>。如果该路径无法使用，则状态为 <code>faulty</code> 或者 <code>shaky</code>。路径的状态由 <code>multipathd</code> 守护进程根据在 <code>/etc/multipath.conf</code> 文件中定义的轮询间隔进行定期更新。</p>
<p>dm 状态与路径状态相似，但从内核来看，dm 有两个状态：<code>failed</code>（类似 <code>faulty</code>）和 <code>active</code>（涵盖所有其它路径状态）。少数情况下，设备的路径状态和 dm 状态会暂时不同。</p>
<p><em>online_status</em> 的可能值为 <code>running</code> 和 <code>offline</code>。<code>offline</code> 意味着这个 SCSI 设备已被禁用。</p>
<p><strong><em>注意</em></strong></p>
<p><em>生成或者修改多路径设备时，路径组群状态、dm 设备名称、写入权限和 dm 状态是未知的。另外，功能也不一定正确。</em></p>
<h2 id="使用多路径命令进行多路径查询"><a href="#使用多路径命令进行多路径查询" class="headerlink" title="使用多路径命令进行多路径查询"></a>使用多路径命令进行多路径查询</h2><p>可以使用 <code>multipath</code> 命令的 <code>-l</code> 和 <code>-ll</code> 选项来显示当前 multipath 配置。<code>-l</code> 选项会显示从 <code>sysfs</code> 以及设备映射器中的信息搜集到的多路径拓扑。<code>-ll</code> 选项会显示 <code>-l</code> 选项显示的信息以及系统的其他可用组件。</p>
<p>显示多路径配置时，可以使用 <code>multipath</code> 命令的 <code>-v</code> 选项指定三种详细等级。指定为 <code>-v0</code> 时没有输出。指定为 <code>-v1</code> 则只输出生成或者更新的路径名称。指定 <code>-v2</code> 将输出所有检测到的路径、多路径和设备映射。</p>
<p>以下示例显示了 <code>multipath -l</code> 命令的输出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># multipath -l</span></span><br><span class="line">3600d0230000000000e13955cc3757800 dm-1 WINSYS,SF2372</span><br><span class="line">size=269G features=<span class="string">'0'</span> hwhandler=<span class="string">'0'</span> wp=rw</span><br><span class="line">|-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=active</span><br><span class="line">| `- 6:0:0:0 sdb 8:16  active ready  running</span><br><span class="line">`-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=enabled</span><br><span class="line">  `- 7:0:0:0 sdf 8:80  active ready  running</span><br></pre></td></tr></table></figure>
<p>以下示例显示了 <code>multipath -l1</code> 命令的输出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># multipath -ll</span></span><br><span class="line">3600d0230000000000e13955cc3757801 dm-10 WINSYS,SF2372</span><br><span class="line">size=269G features=<span class="string">'0'</span> hwhandler=<span class="string">'0'</span> wp=rw</span><br><span class="line">|-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=enabled</span><br><span class="line">| `- 19:0:0:1 sdc 8:32  active ready  running</span><br><span class="line">`-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=enabled</span><br><span class="line">  `- 18:0:0:1 sdh 8:112 active ready  running</span><br><span class="line">3600d0230000000000e13955cc3757803 dm-2 WINSYS,SF2372</span><br><span class="line">size=125G features=<span class="string">'0'</span> hwhandler=<span class="string">'0'</span> wp=rw</span><br><span class="line">`-+- policy=<span class="string">'round-robin 0'</span> prio=1 status=active</span><br><span class="line">  |- 19:0:0:3 sde 8:64  active ready  running</span><br><span class="line">  `- 18:0:0:3 sdj 8:144 active ready  running</span><br></pre></td></tr></table></figure>
<h2 id="多路径命令选项"><a href="#多路径命令选项" class="headerlink" title="多路径命令选项"></a>多路径命令选项</h2><p>表 5.1 “有用的 <code>multipath</code> 命令选项”描述了一些您可能会用到的 <code>multipath</code> 命令选项。</p>
<p>⁠</p>
<p><strong>表 5.1. 有用的 multipath 命令选项</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-l</code></td>
<td>显示来自 <code>sysfs</code> 和设备映射器的当前多路径配置。</td>
</tr>
<tr>
<td><code>-ll</code></td>
<td>显示来自 <code>sysfs</code> 、设备映射器以及系统中其他所有可用组件的当前多路径配置。</td>
</tr>
<tr>
<td><code>-f *device*</code></td>
<td>删除命名的多路径设备。</td>
</tr>
<tr>
<td><code>-F</code></td>
<td>删除所有不使用的多路经设备。</td>
</tr>
<tr>
<td><code>-w *device*</code></td>
<td>从 <code>wwids</code> 文件中删除指定设备的 <code>wwid</code>。</td>
</tr>
<tr>
<td><code>-W</code></td>
<td>重新设定 <code>wwids</code> 文件使其只包含当前 multipath 设备。</td>
</tr>
</tbody>
</table>
</div>
<h2 id="使用-DMSETUP-命令确定设备映射器条目"><a href="#使用-DMSETUP-命令确定设备映射器条目" class="headerlink" title="使用 DMSETUP 命令确定设备映射器条目"></a>使用 DMSETUP 命令确定设备映射器条目</h2><p>可以使用 <code>dmsetup</code> 找出哪个设备映射器条目与多路径的设备映射。</p>
<p>以下命令显示所有设备映射器设备及其主、副号码。副号码确定 dm 设备的名称。例如：副号码 3 与多路径的设备 <code>/dev/dm-3</code> 对映。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dmsetup ls</span></span><br><span class="line">mpathd  (253:4)</span><br><span class="line">mpathep1        (253:12)</span><br><span class="line">mpathfp1        (253:11)</span><br><span class="line">mpathb  (253:3)</span><br><span class="line">mpathgp1        (253:14)</span><br><span class="line">mpathhp1        (253:13)</span><br><span class="line">mpatha  (253:2)</span><br><span class="line">mpathh  (253:9)</span><br><span class="line">mpathg  (253:8)</span><br><span class="line">VolGroup00-LogVol01     (253:1)</span><br><span class="line">mpathf  (253:7)</span><br><span class="line">VolGroup00-LogVol00     (253:0)</span><br><span class="line">mpathe  (253:6)</span><br><span class="line">mpathbp1        (253:10)</span><br><span class="line">mpathd  (253:5)</span><br></pre></td></tr></table></figure>
<h2 id="MULTIPATHD-命令"><a href="#MULTIPATHD-命令" class="headerlink" title="MULTIPATHD 命令"></a>MULTIPATHD 命令</h2><p>可使用 <code>multipathd</code> 命令管理 <code>multipathd</code> 守护进程。有关可用的 <code>multipathd</code> 命令的详情，请查看 <code>multipathd</code>(8) 手册页。</p>
<p>某些 <code>multipathd</code> 命令包含 <code>format</code> 选项，后接通配符。可以使用以下命令显示可用的通配符清单。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># multipathd show wildcards</span></span><br></pre></td></tr></table></figure>
<p>从 Red Hat Enterprise Linux release 7.3 开始，<code>multipathd</code> 命令支持新格式命令，以便显示多路径状态以及使用 “raw”格式版本的路径。在 raw 格式中，不会显示标头，且不会添加字段以便将标头与该列对其。反之，该字段以指定的格式显示。这样就可以更好地使用输出结果编写脚本。现在可使用 <code>multipathd show wildcards</code> 命令显示格式字符串中的通配符。</p>
<p>要按照 <code>multipathd</code> 命令显示 <code>multipathd</code> 监控的多路径设备，使用带多路径通配符的格式字符串，可以是常规格式，也可以是 raw 格式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">list|show maps|multipaths format <span class="variable">$format</span></span><br><span class="line">list|show maps|multipaths raw format <span class="variable">$format</span></span><br></pre></td></tr></table></figure>
<p>以下 <code>multipathd</code> 命令显示 <code>multipathd</code> 监控的多路径设备，使用带多路径通配符的格式字符串，可以是常规格式，也可以是 raw 格式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">list|show paths format <span class="variable">$format</span></span><br><span class="line">list|show paths raw format <span class="variable">$format</span></span><br></pre></td></tr></table></figure>
<p>以下命令显示 <code>multipathd show maps</code> 中非 raw 和 raw 格式之间的不同。注：在 <code>raw</code> 格式中没有标头，只在每个列之间有一个空格。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># multipathd show maps format "%n %w %d %s"</span></span><br><span class="line">name   uuid                              sysfs vend/prod/rev</span><br><span class="line">mpathc 360a98000324669436c2b45666c567942 dm-0  NETAPP,LUN   </span><br><span class="line"></span><br><span class="line"><span class="comment"># multipathd show maps raw format "%n %w %d %s"</span></span><br><span class="line">mpathc 360a98000324669436c2b45666c567942 dm-0 NETAPP,LUN</span><br></pre></td></tr></table></figure>
<h2 id="使用-MULTIPATHD-互动控制台进行故障排除"><a href="#使用-MULTIPATHD-互动控制台进行故障排除" class="headerlink" title="使用 MULTIPATHD 互动控制台进行故障排除"></a>使用 MULTIPATHD 互动控制台进行故障排除</h2><p><code>multipathd -k</code> 命令是 <code>multipathd</code> 守护程序的交互式界面。输入这一命令将进入交互式多路径控制台。执行此命令后，就可以输入 <code>help</code> 获取可用命令列表。可输入交互式命令，或者按 <code>CTRL-D</code> 退出。</p>
<p><code>multipathd</code> 交互式控制台可用来在系统出问题时进行故障排除。例如：以下命令会在退出控制台前显示多路径配置，其中包括默认配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># multipathd -k</span></span><br><span class="line">&gt; &gt; show config</span><br><span class="line">&gt; &gt; CTRL-D</span><br></pre></td></tr></table></figure>
<p>以下命令确定多路径已经识别了所有对 <code>multipath.conf</code> 的修改。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># multipathd -k</span></span><br><span class="line">&gt; &gt; reconfigure</span><br><span class="line">&gt; &gt; CTRL-D</span><br><span class="line"><span class="comment"># multipathd -k</span></span><br><span class="line">&gt; &gt; show paths</span><br><span class="line">&gt; &gt; CTRL-D</span><br></pre></td></tr></table></figure>
<h2 id="删除软件包后清除多路径文件"><a href="#删除软件包后清除多路径文件" class="headerlink" title="删除软件包后清除多路径文件"></a>删除软件包后清除多路径文件</h2><p>如果不小心删除了 <code>device-mapper-multipath</code> <code>rpm</code>. 文件，请注意这不会删除 <code>/etc/multipath.conf</code>、<code>/etc/multipath/bindings</code> 和 <code>/etc/multipath/wwids</code> 文件。但可能需要在后续 <code>device-mapper-multipath</code> 软件包安装中手动删除这些文件。</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Goooo
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://www.sysctl.me/2017/09/16/Linux/storage/multipath/" title="Device Mapper Multipathing">https://www.sysctl.me/2017/09/16/Linux/storage/multipath/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/en" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/Storage/" rel="tag"># Storage</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2017/09/16/Linux/storage/iSCSI/" rel="prev" title="Target实现（IP SAN）">
      <i class="fa fa-chevron-left"></i> Target实现（IP SAN）
    </a></div>
      <div class="post-nav-item">
    <a href="/2017/09/29/Linux/storage/MegaCli/" rel="next" title="MegaCli使用方法">
      MegaCli使用方法 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#第-1-章-简单MULTIPATH-功能实现"><span class="nav-number">1.</span> <span class="nav-text">第 1 章 简单MULTIPATH 功能实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#实现dm功能"><span class="nav-number">1.1.</span> <span class="nav-text">实现dm功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DM-MULTIPATH-概述"><span class="nav-number">1.2.</span> <span class="nav-text">DM MULTIPATH 概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#存储阵列支持"><span class="nav-number">1.3.</span> <span class="nav-text">存储阵列支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DM-MULTIPATH-组件"><span class="nav-number">1.4.</span> <span class="nav-text">DM MULTIPATH 组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DM-MULTIPATH-设置概述"><span class="nav-number">1.5.</span> <span class="nav-text">DM MULTIPATH 设置概述</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第-2-章-多路径设备"><span class="nav-number">2.</span> <span class="nav-text">第 2 章 多路径设备</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#多路径设备识别符"><span class="nav-number">2.1.</span> <span class="nav-text">多路径设备识别符</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在集群中保持多路径设备名称一致"><span class="nav-number">2.2.</span> <span class="nav-text">在集群中保持多路径设备名称一致</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多路径设备属性"><span class="nav-number">2.3.</span> <span class="nav-text">多路径设备属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#逻辑卷中的多路径设备"><span class="nav-number">2.4.</span> <span class="nav-text">逻辑卷中的多路径设备</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第-3-章-设置-DM-MULTIPATH"><span class="nav-number">3.</span> <span class="nav-text">第 3 章 设置 DM MULTIPATH</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#设置-DM-MULTIPATH"><span class="nav-number">3.1.</span> <span class="nav-text">设置 DM MULTIPATH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在生成多路径设备时忽略逻辑磁盘"><span class="nav-number">3.2.</span> <span class="nav-text">在生成多路径设备时忽略逻辑磁盘</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置存储设备"><span class="nav-number">3.3.</span> <span class="nav-text">配置存储设备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在-INITRAMFS-文件系统中设置启动-MULTIPATH"><span class="nav-number">3.4.</span> <span class="nav-text">在 INITRAMFS 文件系统中设置启动 MULTIPATH</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第-4-章-DM-MULTIPATH-配置文件"><span class="nav-number">4.</span> <span class="nav-text">第 4 章 DM MULTIPATH 配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件概述"><span class="nav-number">4.1.</span> <span class="nav-text">配置文件概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件黑名单"><span class="nav-number">4.2.</span> <span class="nav-text">配置文件黑名单</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#根据-WWID-将设备列入黑名单"><span class="nav-number">4.2.1.</span> <span class="nav-text">根据 WWID 将设备列入黑名单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#根据设备名称将设备列入黑名单"><span class="nav-number">4.2.2.</span> <span class="nav-text">根据设备名称将设备列入黑名单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#根据设备类型将其加入黑名单"><span class="nav-number">4.2.3.</span> <span class="nav-text">根据设备类型将其加入黑名单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#黑名单之外的设备"><span class="nav-number">4.2.4.</span> <span class="nav-text">黑名单之外的设备</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件默认设置"><span class="nav-number">4.3.</span> <span class="nav-text">配置文件默认设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多路径设备配置属性"><span class="nav-number">4.4.</span> <span class="nav-text">多路径设备配置属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件设备"><span class="nav-number">4.5.</span> <span class="nav-text">配置文件设备</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第-5-章-DM-MULTIPATH-管理及故障排除"><span class="nav-number">5.</span> <span class="nav-text">第 5 章 DM MULTIPATH 管理及故障排除</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用多路径帮助程序（MULTIPATH-HELPER）自动生成配置文件"><span class="nav-number">5.1.</span> <span class="nav-text">使用多路径帮助程序（MULTIPATH HELPER）自动生成配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重新定义在线多路径设备大小"><span class="nav-number">5.2.</span> <span class="nav-text">重新定义在线多路径设备大小</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#将-ROOT-文件系统从单路径设备移动到多路径设备中"><span class="nav-number">5.3.</span> <span class="nav-text">将 ROOT 文件系统从单路径设备移动到多路径设备中</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#将-SWAP-文件系统从单路径设备移动到多路径设备中"><span class="nav-number">5.4.</span> <span class="nav-text">将 SWAP 文件系统从单路径设备移动到多路径设备中</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多路径守护进程"><span class="nav-number">5.5.</span> <span class="nav-text">多路径守护进程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#大量-LUN-造成的问题"><span class="nav-number">5.6.</span> <span class="nav-text">大量 LUN 造成的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#有-QUEUE-IF-NO-PATH-功能的问题"><span class="nav-number">5.7.</span> <span class="nav-text">有 QUEUE_IF_NO_PATH 功能的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多路径命令输出"><span class="nav-number">5.8.</span> <span class="nav-text">多路径命令输出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用多路径命令进行多路径查询"><span class="nav-number">5.9.</span> <span class="nav-text">使用多路径命令进行多路径查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多路径命令选项"><span class="nav-number">5.10.</span> <span class="nav-text">多路径命令选项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-DMSETUP-命令确定设备映射器条目"><span class="nav-number">5.11.</span> <span class="nav-text">使用 DMSETUP 命令确定设备映射器条目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MULTIPATHD-命令"><span class="nav-number">5.12.</span> <span class="nav-text">MULTIPATHD 命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-MULTIPATHD-互动控制台进行故障排除"><span class="nav-number">5.13.</span> <span class="nav-text">使用 MULTIPATHD 互动控制台进行故障排除</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#删除软件包后清除多路径文件"><span class="nav-number">5.14.</span> <span class="nav-text">删除软件包后清除多路径文件</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Goooo"
      src="/images/img.png">
  <p class="site-author-name" itemprop="name">Goooo</p>
  <div class="site-description" itemprop="description">真正的粉丝</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">110</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">71</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xth0331" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xth0331" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:xietianhao0331@gmail.com" title="E-Mail → mailto:xietianhao0331@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/en" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
        
        <script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
        <script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
        <div class="widget-wrap">
            <h3 class="widget-title">标签们</h3>
            <div id="myCanvasContainer" class="widget tagcloud">
                <canvas width="250" height="250" id="resCanvas" style="width=100%">
                    <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ansible/" rel="tag">Ansible</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Backup/" rel="tag">Backup</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bond/" rel="tag">Bond</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CPU/" rel="tag">CPU</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ceph/" rel="tag">Ceph</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cobbler/" rel="tag">Cobbler</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Coffee/" rel="tag">Coffee</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Corosync/" rel="tag">Corosync</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cyclic-invariant/" rel="tag">Cyclic invariant</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Effectiveness/" rel="tag">Effectiveness</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Exhaustion/" rel="tag">Exhaustion</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Filesystem/" rel="tag">Filesystem</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HAProxy/" rel="tag">HAProxy</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hardware/" rel="tag">Hardware</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Https/" rel="tag">Https</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ICMP/" rel="tag">ICMP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDK/" rel="tag">JDK</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JunOS/" rel="tag">JunOS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KEEPALIVED/" rel="tag">KEEPALIVED</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Keepalived/" rel="tag">Keepalived</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Log/" rel="tag">Log</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/" rel="tag">Markdown</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Modular-Programming/" rel="tag">Modular Programming</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Monitoring/" rel="tag">Monitoring</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netconf/" rel="tag">Netconf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/" rel="tag">Network</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Networking/" rel="tag">Networking</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OS/" rel="tag">OS</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenStack/" rel="tag">OpenStack</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Package-Manager/" rel="tag">Package Manager</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Partition/" rel="tag">Partition</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Programming/" rel="tag">Programming</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RAM/" rel="tag">RAM</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RHCS/" rel="tag">RHCS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPM/" rel="tag">RPM</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Recursion/" rel="tag">Recursion</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Recursive/" rel="tag">Recursive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redirect/" rel="tag">Redirect</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Route/" rel="tag">Route</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSH/" rel="tag">SSH</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Storage/" rel="tag">Storage</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Storage-and-Filesystem/" rel="tag">Storage and Filesystem</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swap/" rel="tag">Swap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sys/" rel="tag">Sys</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Systemd/" rel="tag">Systemd</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Terminal/" rel="tag">Terminal</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Terraform/" rel="tag">Terraform</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tools/" rel="tag">Tools</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/" rel="tag">Ubuntu</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Veeam/" rel="tag">Veeam</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vim/" rel="tag">Vim</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Virtualization/" rel="tag">Virtualization</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vmware/" rel="tag">Vmware</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vsphere/" rel="tag">Vsphere</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/" rel="tag">Windows</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yum/" rel="tag">Yum</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apple/" rel="tag">apple</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch/" rel="tag">elasticsearch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iteration/" rel="tag">iteration</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logs/" rel="tag">logs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oop/" rel="tag">oop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/" rel="tag">tools</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E6%B2%BB/" rel="tag">分治</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%8E%8B%E7%BC%A9/" rel="tag">数据压缩</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%84%99%E8%A7%86%E9%93%BE/" rel="tag">鄙视链</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%87%8D%E5%A4%8D%E6%95%B0%E6%8D%AE%E5%88%A0%E9%99%A4/" rel="tag">重复数据删除</a><span class="tag-list-count">1</span></li></ul>
                </canvas>
            </div>
        </div>
        
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Goooo</span>
</div>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://www-sysctl-me-1.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://www.sysctl.me/2017/09/16/Linux/storage/multipath/";
    this.page.identifier = "2017/09/16/Linux/storage/multipath/";
    this.page.title = "Device Mapper Multipathing";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://www-sysctl-me-1.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":300,"height":600},"mobile":{"show":false},"react":{"opacity":0.7}});</script></body>
</html>
